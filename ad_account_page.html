<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Conta de Anúncios Meta</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;

        // Inicializa Firebase e autentica
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase autenticado. User ID:", userId);
                        loadMetaAdsData(); // Carrega os dados da API Meta após autenticação
                    } else {
                        console.log("Nenhum usuário logado.");
                        // Fallback para userId se não autenticado (ex: para dados públicos)
                        userId = crypto.randomUUID(); // Gera um ID temporário
                        loadMetaAdsData();
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                document.getElementById('totalSpend').textContent = 'Erro';
                document.getElementById('totalClicks').textContent = 'Erro';
                document.getElementById('averageCpc').textContent = 'Erro';
                document.getElementById('totalPurchases').textContent = 'Erro';
                document.getElementById('totalConversionValue').textContent = 'Erro';
                document.getElementById('averageRoas').textContent = 'Erro';
                document.getElementById('insightsDisplay').innerHTML = `<p style="color: red;">Erro ao carregar dados: ${error.message}</p>`;
            }
        };

        // --- SEUS DADOS DE ACESSO ---
        // ATENÇÃO: Este token é sensível e não deve ser compartilhado publicamente.
        // Para uso pessoal e local, é aceitável. Para hospedagem online,
        // considere usar um backend para proteger seu token.
        const ACCESS_TOKEN = 'EAAIyWkoZCTyQBPEQzRpMzykm81UXdgjfLGI1PCMZBdPj05KlDlb3DWSZBkKHpDArZA8F2sIE6GHuiOls2ThHyRkkZA25cZA3wKxTLx8vqQpZByk39lxiuBsMvGZCZCtbjNLkrBSA5SRJNoYEwGaMfZAaLdhhx5CHJWVz25390W5cC7dN5u0dEoi2uEHGJqsIE1A1RsWKm85CRD29Lz1FfE3ksU';

        // Obtém o ID da conta de anúncios da URL
        const urlParams = new URLSearchParams(window.location.search);
        const AD_ACCOUNT_ID = urlParams.get('account_id');

        if (!AD_ACCOUNT_ID) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('adAccountName').textContent = 'ID da Conta Não Encontrado';
                document.getElementById('totalSpend').textContent = 'N/A';
                document.getElementById('totalClicks').textContent = 'N/A';
                document.getElementById('averageCpc').textContent = 'N/A';
                document.getElementById('totalPurchases').textContent = 'N/A';
                document.getElementById('totalConversionValue').textContent = 'N/A';
                document.getElementById('averageRoas').textContent = 'N/A';
                document.getElementById('insightsDisplay').innerHTML = '<p style="color: red;">Por favor, forneça um ID de conta de anúncios válido na URL (ex: ad_account_page.html?account_id=act_SEUID).</p>';
            });
            throw new Error("ID da Conta de Anúncios não fornecido na URL.");
        }

        // Elementos do DOM
        const adAccountNameElement = document.getElementById('adAccountName');
        const totalSpendElement = document.getElementById('totalSpend');
        const totalClicksElement = document.getElementById('totalClicks');
        const averageCpcElement = document.getElementById('averageCpc');
        const totalRoasElement = document.getElementById('totalRoas');
        const totalPurchasesElement = document.getElementById('totalPurchases');
        const totalConversionValueElement = document.getElementById('totalConversionValue');
        const insightsDisplayElement = document.getElementById('insightsDisplay');
        const filterButtons = document.querySelectorAll('.filter-button');
        const incrementButtons = document.querySelectorAll('.increment-button');

        let currentTimeRange = 'today'; // Define 'today' como período padrão
        let currentTimeIncrement = 'daily'; // Define 'daily' como agrupamento padrão
        let campaignNamesMap = new Map(); // Mapa para armazenar IDs de campanha para nomes

        // Função para formatar valores monetários para Real Brasileiro (BRL)
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };

        // Função para formatar ROAS como porcentagem ou número
        const formatRoas = (value) => {
            if (value === null || isNaN(value)) return 'N/A';
            return value.toFixed(2); // Formata para 2 casas decimais
        };

        // Função para formatar CPC
        const formatCpc = (spend, clicks) => {
            if (clicks === 0 || isNaN(spend) || isNaN(clicks)) return 'N/A';
            return formatCurrency(spend / clicks);
        };

        // Função para obter a data no formato YYYY-MM-DD
        const getDateString = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Função para calcular o período de tempo com base na seleção
        const getTimeRangeDates = (range) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Zera hora para consistência

            let sinceDate, untilDate;

            switch (range) {
                case 'today':
                    sinceDate = today;
                    untilDate = today;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    sinceDate = yesterday;
                    untilDate = yesterday;
                    break;
                case 'last_7_days':
                    untilDate = today;
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 6); // Inclui hoje, então 6 dias atrás
                    sinceDate = sevenDaysAgo;
                    break;
                default: // Padrão para hoje
                    sinceDate = today;
                    untilDate = today;
            }

            return {
                since: getDateString(sinceDate),
                until: getDateString(untilDate)
            };
        };

        // Função para buscar os nomes das campanhas e mapeá-los por ID
        const fetchCampaignNames = async (accountId) => {
            const campaignsUrl = `https://graph.facebook.com/v19.0/${accountId}/campaigns?fields=id,name&access_token=${ACCESS_TOKEN}`;
            const response = await fetch(campaignsUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erro ao buscar nomes das campanhas: ${errorData.error.message}`);
            }
            const data = await response.json();
            campaignNamesMap.clear(); // Limpa o mapa anterior
            data.data.forEach(campaign => {
                campaignNamesMap.set(campaign.id, campaign.name);
            });
        };

        // Função para salvar o resumo da conta no Firestore
        const saveAccountSummary = async (summaryData) => {
            if (!db || !userId) {
                console.warn("Firestore ou User ID não estão prontos para salvar o resumo.");
                return;
            }
            try {
                // Salva no caminho: artifacts/{appId}/users/{userId}/ad_account_summaries/{accountId}
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/ad_account_summaries`, AD_ACCOUNT_ID);
                await setDoc(docRef, summaryData, { merge: true }); // merge: true para atualizar campos existentes
                console.log("Resumo da conta salvo no Firestore com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar resumo da conta no Firestore:", error);
            }
        };

        // Função principal para carregar e exibir os dados do Meta Ads
        const loadMetaAdsData = async () => {
            // Define o estado inicial de carregamento para todas as métricas e display
            adAccountNameElement.textContent = `Conta: ${AD_ACCOUNT_ID} (Carregando...)`;
            totalSpendElement.textContent = 'Carregando...';
            totalClicksElement.textContent = 'Carregando...';
            averageCpcElement.textContent = 'Carregando...';
            totalRoasElement.textContent = 'Carregando...';
            totalPurchasesElement.textContent = 'Carregando...';
            totalConversionValueElement.textContent = 'Carregando...';
            insightsDisplayElement.innerHTML = '<p>Carregando dados...</p>';

            try {
                // Primeiro, busca os nomes das campanhas para a conta selecionada
                await fetchCampaignNames(AD_ACCOUNT_ID);

                // Tenta obter o nome da conta de anúncios
                const accountInfoUrl = `https://graph.facebook.com/v19.0/${AD_ACCOUNT_ID}?fields=name&access_token=${ACCESS_TOKEN}`;
                const accountInfoResponse = await fetch(accountInfoUrl);
                if (accountInfoResponse.ok) {
                    const accountInfoData = await accountInfoResponse.json();
                    adAccountNameElement.textContent = `Conta: ${accountInfoData.name} (ID: ${AD_ACCOUNT_ID})`;
                } else {
                    adAccountNameElement.textContent = `Conta: ${AD_ACCOUNT_ID} (Nome indisponível)`;
                }


                const { since, until } = getTimeRangeDates(currentTimeRange);

                let apiUrl;
                // Incluído 'clicks' nos campos base
                const baseFields = 'spend,clicks,actions,action_values,roas'; 

                // Lógica para construir a URL da API com base no agrupamento selecionado
                if (currentTimeIncrement === 'daily' || currentTimeIncrement === 'hourly') {
                    // Para agrupamentos diários/horários, solicitamos no nível da campanha.
                    // Não incluímos 'campaign_name' explicitamente nos 'fields' para evitar o erro.
                    // A API deve retornar o campaign_id, que usaremos para buscar o nome do mapa.
                    apiUrl = `https://graph.facebook.com/v19.0/${AD_ACCOUNT_ID}/insights?` +
                               `fields=campaign_id,${baseFields}&` + // Solicita campaign_id, mas NÃO campaign_name
                               `time_range={'since':'${since}','until':'${until}'}&` +
                               `time_increment=${currentTimeIncrement}&` +
                               `level=campaign&` + // Nível da campanha
                               `access_token=${ACCESS_TOKEN}`;
                } else { // Isso cobre 'all_days' (Total do Período) e qualquer 'monthly' futuro
                    // Para 'all_days', podemos solicitar 'campaign_name' explicitamente nos fields
                    // pois essa combinação é permitida com level=campaign.
                    apiUrl = `https://graph.facebook.com/v19.0/${AD_ACCOUNT_ID}/insights?` +
                               `fields=campaign_name,campaign_id,${baseFields}&` + // Solicita campaign_name E campaign_id
                               `time_range={'since':'${since}','until':'${until}'}&` +
                               `time_increment=${currentTimeIncrement}&` + // Será 'all_days'
                               `level=campaign&` + // Nível da campanha
                               `access_token=${ACCESS_TOKEN}`;
                }

                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro da API Meta: ${errorData.error.message} (Código: ${errorData.error.code})`);
                }

                const data = await response.json();
                const insights = data.data; // Os dados de insights estão na propriedade 'data'

                // Inicializa totais para esta conta
                let currentAccountTotalSpend = 0;
                let currentAccountTotalClicks = 0;
                let currentAccountTotalPurchases = 0;
                let currentAccountTotalConversionValue = 0;
                let currentAccountTotalRoasSum = 0;
                let currentAccountRoasCount = 0;

                insightsDisplayElement.innerHTML = ''; // Limpa o display anterior

                if (insights && insights.length > 0) {
                    // Iterar sobre cada insight (que pode ser por dia/hora ou por campanha)
                    insights.forEach(insight => {
                        currentAccountTotalSpend += parseFloat(insight.spend || 0);
                        currentAccountTotalClicks += parseFloat(insight.clicks || 0);

                        // Processa ações e valores de ações
                        if (insight.actions) {
                            insight.actions.forEach(action => {
                                if (action.action_type === 'purchase') {
                                    currentAccountTotalPurchases += parseFloat(action.value || 0);
                                }
                            });
                        }
                        if (insight.action_values) {
                            insight.action_values.forEach(actionValue => {
                                if (actionValue.action_type === 'purchase') {
                                    currentAccountTotalConversionValue += parseFloat(actionValue.value || 0);
                                }
                            });
                        }

                        // Agrega ROAS para cálculo da média
                        if (insight.roas && insight.roas.length > 0) {
                            const roasValue = parseFloat(insight.roas[0].value || 0);
                            if (roasValue > 0) { // Apenas inclui ROAS válidos na média
                                currentAccountTotalRoasSum += roasValue;
                                currentAccountRoasCount++;
                            }
                        }

                        // Exibe os detalhes por dia/hora/campanha
                        const insightItem = document.createElement('div');
                        insightItem.classList.add('insight-item');

                        // Determina a exibição do período com base no time_increment
                        let periodDisplay = `Período: ${insight.date_start}`;
                        if (currentTimeIncrement === 'hourly') {
                            periodDisplay += ` Hora: ${insight.date_stop.substring(11, 16)}`;
                        } else if (currentTimeIncrement === 'daily' && insight.date_start !== insight.date_stop) {
                            periodDisplay += ` - ${insight.date_stop}`;
                        }

                        let itemContent = `<strong>${periodDisplay}</strong><br>`;

                        // Obtém o nome da campanha usando o mapa (para daily/hourly)
                        // ou diretamente do insight (para all_days)
                        const campaignName = insight.campaign_name || campaignNamesMap.get(insight.campaign_id) || 'N/A';
                        itemContent += `<div class="label">Campanha:</div><span>${campaignName}</span>`;
                        
                        itemContent += `<div class="label">Gasto:</div><span>${formatCurrency(parseFloat(insight.spend || 0))}</span>`;
                        itemContent += `<div class="label">Cliques:</div><span>${parseFloat(insight.clicks || 0).toFixed(0)}</span>`;
                        itemContent += `<div class="label">CPC:</div><span>${formatCpc(parseFloat(insight.spend || 0), parseFloat(insight.clicks || 0))}</span>`;
                        
                        let itemPurchases = 0;
                        let itemConversionValue = 0;
                        if (insight.actions) {
                            insight.actions.forEach(action => {
                                if (action.action_type === 'purchase') {
                                    itemPurchases += parseFloat(action.value || 0);
                                }
                            });
                        }
                        if (insight.action_values) {
                            insight.action_values.forEach(actionValue => {
                                if (actionValue.action_type === 'purchase') {
                                    itemConversionValue += parseFloat(actionValue.value || 0);
                                }
                            });
                        }
                        itemContent += `<div class="label">Compras:</div><span>${itemPurchases.toFixed(0)}</span>`;
                        itemContent += `<div class="label">Valor Conversão:</div><span>${formatCurrency(itemConversionValue)}</span>`;
                        itemContent += `<div class="label">ROAS:</div><span>${formatRoas(insight.roas && insight.roas.length > 0 ? parseFloat(insight.roas[0].value) : null)}</span>`;

                        insightItem.innerHTML = itemContent;
                        insightsDisplayElement.appendChild(insightItem);
                    });

                    // Atualiza as métricas totais no topo do dashboard
                    totalSpendElement.textContent = formatCurrency(currentAccountTotalSpend);
                    totalClicksElement.textContent = currentAccountTotalClicks.toFixed(0);
                    averageCpcElement.textContent = formatCpc(currentAccountTotalSpend, currentAccountTotalClicks);
                    totalPurchasesElement.textContent = currentAccountTotalPurchases.toFixed(0);
                    totalConversionValueElement.textContent = formatCurrency(currentAccountTotalConversionValue);
                    totalRoasElement.textContent = currentAccountRoasCount > 0 ? formatRoas(currentAccountTotalRoasSum / currentAccountRoasCount) : 'N/A';

                    // Salva o resumo da conta no Firestore
                    await saveAccountSummary({
                        accountName: adAccountNameElement.textContent.replace(` (ID: ${AD_ACCOUNT_ID})`, '').replace('Conta: ', ''),
                        totalSpend: currentAccountTotalSpend,
                        totalClicks: currentAccountTotalClicks,
                        totalPurchases: currentAccountTotalPurchases,
                        totalConversionValue: currentAccountTotalConversionValue,
                        averageRoas: currentAccountRoasCount > 0 ? (currentAccountTotalRoasSum / currentAccountRoasCount) : 0,
                        lastUpdated: new Date().toISOString()
                    });

                } else {
                    insightsDisplayElement.innerHTML = '<p>Nenhum dado encontrado para o período e conta selecionados.</p>';
                    totalSpendElement.textContent = formatCurrency(0);
                    totalClicksElement.textContent = '0';
                    averageCpcElement.textContent = 'N/A';
                    totalRoasElement.textContent = 'N/A';
                    totalPurchasesElement.textContent = '0';
                    totalConversionValueElement.textContent = formatCurrency(0);
                }

            } catch (error) {
                console.error('Erro ao carregar dados do Meta Ads:', error);
                totalSpendElement.textContent = 'Erro';
                totalClicksElement.textContent = 'Erro';
                averageCpcElement.textContent = 'Erro';
                totalRoasElement.textContent = 'Erro';
                totalPurchasesElement.textContent = 'Erro';
                totalConversionValueElement.textContent = 'Erro';
                insightsDisplayElement.innerHTML = `
                    <p style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px;">
                        Ocorreu um erro ao carregar os dados: ${error.message}.
                        Por favor, verifique seu Token de Acesso, ID da Conta de Anúncios
                        e as permissões necessárias (ads_read, ads_management).
                    </p>
                `;
            }
        };

        // --- Event Listeners para os Controles ---

        // Eventos para botões de filtro de período (Hoje, Ontem, Últimos 7 Dias)
        filterButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                // Remove a classe 'active' de todos os botões e adiciona ao clicado
                filterButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                currentTimeRange = event.target.dataset.timeRange;
                loadMetaAdsData(); // Recarrega os dados com o novo período
            });
        });

        // Eventos para botões de agrupamento (Por Dia, Por Hora, Total do Período)
        incrementButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                // Remove a classe 'active' de todos os botões e adiciona ao clicado
                incrementButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                currentTimeIncrement = event.target.dataset.timeIncrement;
                loadMetaAdsData(); // Recarrega os dados com o novo agrupamento
            });
        });

        // Inicializa o Firebase quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">← Voltar ao Dashboard Principal</a>
        <h1 id="adAccountName">Detalhes da Conta de Anúncios</h1>

        <div class="controls">
            <div class="control-group">
                <label>Período:</label>
                <button class="filter-button active" data-time-range="today">Hoje</button>
                <button class="filter-button" data-time-range="yesterday">Ontem</button>
                <button class="filter-button" data-time-range="last_7_days">Últimos 7 Dias</button>
            </div>

            <div class="control-group">
                <label>Agrupamento:</label>
                <button class="increment-button active" data-time-increment="daily">Por Dia</button>
                <button class="increment-button" data-time-increment="hourly">Por Hora</button>
                <button class="increment-button" data-time-increment="all_days">Total do Período</button>
            </div>
        </div>

        <div class="summary-metrics">
            <div class="metric-card">
                <h3>Gasto Total</h3>
                <p id="totalSpend" class="metric-value">Carregando...</p>
            </div>
            <div class="metric-card">
                <h3>Cliques Total</h3>
                <p id="totalClicks" class="metric-value">Carregando...</p>
            </div>
            <div class="metric-card">
                <h3>CPC Médio</h3>
                <p id="averageCpc" class="metric-value">Carregando...</p>
            </div>
            <div class="metric-card">
                <h3>Compras Total</h3>
                <p id="totalPurchases" class="metric-value">Carregando...</p>
            </div>
            <div class="metric-card">
                <h3>Valor Conversão Total</h3>
                <p id="totalConversionValue" class="metric-value">Carregando...</p>
            </div>
            <div class="metric-card">
                <h3>ROAS Médio</h3>
                <p id="averageRoas" class="metric-value">Carregando...</p>
            </div>
        </div>

        <h2>Detalhes por Período/Campanha</h2>
        <div id="insightsDisplay">
            <p>Carregando dados...</p>
        </div>
    </div>
</body>
</html>
