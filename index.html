<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotLead Dashboard - Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body, #root {
            height: 100%;
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #darkModeToggle.spin-active {
            animation: spin 0.5s forwards;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .group:hover .rotate-on-hover {
            transform: rotate(360deg);
            transition: transform 0.5s ease-in-out;
        }
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        .table-container {
            overflow-x: auto;
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .custom-table th, .custom-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #4a4a4a; /* Darker border for dark theme */
        }
        .custom-table th {
            background-color: #3a3a3a; /* Slightly lighter header for dark theme */
            color: #e0e0e0;
            font-weight: 600;
            text-transform: uppercase;
        }
        .custom-table tr:hover {
            background-color: #2a2a2a; /* Lighter hover for dark theme */
        }

        /* Styles for Flow Creator - START */
        /* These styles are specific to the Flow Creator component */
        #flow-creator-page .container {
            display: flex;
            height: calc(100vh - 64px); /* Adjust for header height */
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #flow-creator-page .sidebar-tools {
            width: 200px;
            background-color: #2a2a2a;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        #flow-creator-page .sidebar-tools h3 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 10px;
        }

        #flow-creator-page .tool-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #flow-creator-page .tool-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        #flow-creator-page .tool-button i {
            font-size: 18px;
        }

        #flow-creator-page .flow-canvas-wrapper {
            flex-grow: 1;
            background-color: #1f1f1f;
            position: relative;
            overflow: auto;
            cursor: grab;
        }

        #flow-creator-page .flow-canvas-wrapper.dragging {
            cursor: grabbing;
        }

        #flow-creator-page .flow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            padding: 50px;
            box-sizing: border-box;
            background-image:
                linear-gradient(to right, #2a2a2a 1px, transparent 1px),
                linear-gradient(to bottom, #2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #flow-creator-page .flow-block {
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 10px;
            padding: 15px;
            position: absolute;
            min-width: 250px;
            max-width: 350px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #flow-creator-page .flow-block.selected {
            border-color: #007bff;
            box-shadow: 0 0 0 3px #007bff, 0 4px 15px rgba(0, 0, 0, 0.6);
        }

        #flow-creator-page .block-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a4a4a;
        }

        #flow-creator-page .block-header i {
            font-size: 20px;
            color: #007bff;
        }

        #flow-creator-page .block-header h4 {
            margin: 0;
            color: #f0f0f0;
            font-size: 16px;
        }

        #flow-creator-page .block-content p {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #b0b0b0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #flow-creator-page .block-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        #flow-creator-page .block-button {
            background-color: #4a4a4a;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            text-align: center;
            border: 1px solid #5a5a5a;
        }

        #flow-creator-page .block-media {
            margin-top: 10px;
            text-align: center;
        }
        #flow-creator-page .block-media img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            object-fit: cover;
            margin-bottom: 5px;
        }
        #flow-creator-page .block-media .media-icon {
            font-size: 24px;
            color: #b0b0b0;
            margin-bottom: 5px;
        }
        #flow-creator-page .block-media p {
            font-size: 12px;
            color: #7a7a7a;
            margin: 0;
        }

        #flow-creator-page .flow-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }

        #flow-creator-page .flow-lines line {
            stroke: #007bff;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        #flow-creator-page .properties-panel {
            width: 350px;
            background-color: #2a2a2a;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0; /* Prevent shrinking */
        }

        #flow-creator-page .properties-panel h3 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 10px;
        }

        #flow-creator-page .form-group {
            margin-bottom: 15px;
        }

        #flow-creator-page .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #b0b0b0;
        }

        #flow-creator-page .form-group input[type="text"],
        #flow-creator-page .form-group textarea,
        #flow-creator-page .form-group select,
        #flow-creator-page .form-group input[type="file"] {
            width: calc(100% - 20px);
            padding: 10px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        #flow-creator-page .form-group input[type="file"] {
            padding: 0;
            height: 40px;
            display: flex;
            align-items: center;
        }
        #flow-creator-page .form-group input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
            width: 0;
            padding: 0;
            margin: 0;
        }
        #flow-creator-page .form-group input[type="file"]::before {
            content: 'Escolher Arquivo';
            display: inline-block;
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            border-radius: 5px;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
        }
        #flow-creator-page .form-group input[type="file"]:hover::before {
            background-color: #0056b3;
        }
        #flow-creator-page .form-group input[type="file"]:active::before {
            background-color: #004085;
        }

        #flow-creator-page .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #flow-creator-page .file-input-wrapper input[type="text"] {
            flex-grow: 1;
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            cursor: default;
        }
        #flow-creator-page .clear-file-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        #flow-creator-page .clear-file-btn:hover {
            background-color: #c82333;
        }

        #flow-creator-page .form-group input[type="text"]:focus,
        #flow-creator-page .form-group textarea:focus,
        #flow-creator-page .form-group select:focus {
            border-color: #007bff;
        }

        #flow-creator-page .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        #flow-creator-page .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #flow-creator-page .button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        #flow-creator-page .button-primary {
            background-color: #007bff;
            color: white;
        }

        #flow-creator-page .button-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        #flow-creator-page .button-secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
        }

        #flow-creator-page .button-secondary:hover {
            background-color: #6a6a6a;
            transform: translateY(-1px);
        }

        #flow-creator-page .button-danger {
            background-color: #dc3545;
            color: white;
        }

        #flow-creator-page .button-danger:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }

        #flow-creator-page .add-button-btn {
            background-color: #28a745;
            color: white;
            margin-top: 10px;
            width: 100%;
        }
        #flow-creator-page .add-button-btn:hover {
            background-color: #218838;
        }

        #flow-creator-page .remove-button-btn {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        #flow-creator-page .remove-button-btn:hover {
            background-color: #c82333;
        }

        #flow-creator-page .button-item, #flow-creator-page .header-item, #flow-creator-page .response-item, #flow-creator-page .condition-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: #4a4a4a;
            padding: 8px;
            border-radius: 5px;
        }
        #flow-creator-page .button-item input, #flow-creator-page .header-item input, #flow-creator-page .response-item input, #flow-creator-page .condition-item input, #flow-creator-page .condition-item select {
            flex-grow: 1;
            margin-right: 10px;
        }
        #flow-creator-page .header-item input:nth-child(1), #flow-creator-page .response-item input:nth-child(1), #flow-creator-page .condition-item input:nth-child(1) {
            flex-basis: 40%;
            margin-right: 5px;
        }
        #flow-creator-page .header-item input:nth-child(2), #flow-creator-page .response-item input:nth-child(2), #flow-creator-page .condition-item input:nth-child(2) {
            flex-basis: 40%;
            margin-right: 10px;
        }
        #flow-creator-page .condition-item select {
            flex-basis: 20%;
            margin-right: 5px;
        }

        #flow-creator-page #feedback-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #3a3a3a;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #flow-creator-page #feedback-message.show {
            opacity: 1;
            visibility: visible;
        }
        /* Styles for Flow Creator - END */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="root" class="min-h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Funções de Ajuda ---
        const formatCurrency = (value) => {
            const num = Number(value);
            if (isNaN(num)) return "R$ 0,00";
            // Assume the value is in cents and converts to reais for display
            return (num / 100).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            return d.toLocaleDateString("pt-BR");
        };

        const calculateProfit = (revenue, spending) => {
            return revenue - spending;
        };

        // --- Dados Iniciais (NÃO SÃO MOCKS, mas dados que seriam carregados de APIs) ---

        // Contas de Anúncios (seriam carregadas de uma API real)
        const AD_ACCOUNTS_INITIAL_STATE = []; // Inicia vazio, seria populado por uma API

        // Dados de Bots (seriam carregados de uma API real)
        const BOTS_DATA_INITIAL_STATE = []; // Inicia vazio, seria populado por uma API

        // Dados de Adsets e Ads (seriam carregados de APIs reais da Meta)
        const ADSETS_DATA_INITIAL_STATE = []; // Inicia vazio, seria populado por uma API
        const ADS_DATA_INITIAL_STATE = []; // Inicia vazio, seria populado por uma API


        // --- Componentes ---

        // Componente de Cabeçalho (Header)
        function Header({ onNavigate, currentPage, toggleDarkMode, isDarkMode }) {
            const [isSpinning, setIsSpinning] = useState(false);

            const handleToggleClick = () => {
                setIsSpinning(true);
                toggleDarkMode();
            };

            const handleAnimationEnd = () => {
                setIsSpinning(false);
            };

            return (
                <header className="bg-gray-800 dark:bg-gray-800 text-white p-4 shadow-md dark:shadow-lg dark:border-b dark:border-gray-700">
                    <div className="container mx-auto flex flex-wrap justify-between items-center">
                        <h1 className="text-2xl font-bold text-green-400">HotLead Dashboard</h1>
                        <nav className="mt-4 md:mt-0">
                            <ul className="flex flex-wrap space-x-2 md:space-x-6 justify-center">
                                <li><a href="#" onClick={() => onNavigate('dashboard')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'dashboard' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-chart-line mr-2"></i> Dashboard</a></li>
                                <li><a href="#" onClick={() => onNavigate('sales')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'sales' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-dollar-sign mr-2"></i> Vendas</a></li>
                                <li><a href="#" onClick={() => onNavigate('bots')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'bots' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-robot mr-2"></i> Bots</a></li>
                                <li><a href="#" onClick={() => onNavigate('integrations')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'integrations' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-plug mr-2"></i> Integrações</a></li>
                                <li><a href="#" onClick={() => onNavigate('create-checkout')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'create-checkout' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-plus-circle mr-2"></i> Criar Checkout</a></li>
                                <li><a href="#" onClick={() => onNavigate('campaigns')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'campaigns' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-bullhorn mr-2"></i> Campanhas</a></li>
                                <li><a href="#" onClick={() => onNavigate('flow-creator')} className={`flex items-center px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'flow-creator' ? 'bg-green-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}><i className="fas fa-sitemap mr-2"></i> Criador de Fluxos</a></li>
                            </ul>
                        </nav>
                        <button
                            id="darkModeToggle"
                            onClick={handleToggleClick}
                            onAnimationEnd={handleAnimationEnd}
                            className={`ml-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full transition-colors duration-300 ${isSpinning ? 'spin-active' : ''}`}
                        >
                            <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                        </button>
                    </div>
                </header>
            );
        }

        // --- Componente de Caixa de Mensagem (MessageBox) ---
        function MessageBox({ message, type, onClose }) {
            if (!message) return null;

            let bgColor = '';
            let textColor = '';
            let icon = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'fas fa-times-circle';
                    break;
                case 'info':
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    icon = 'fas fa-info-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-gray-900';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-gray-700';
                    textColor = 'text-white';
                    icon = 'fas fa-info-circle';
            }

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4`}>
                    <div className={`${bgColor} ${textColor} p-6 rounded-lg shadow-xl max-w-sm w-full text-center relative`}>
                        <button
                            onClick={onClose}
                            className="absolute top-3 right-3 text-lg font-bold p-1 rounded-full hover:bg-opacity-80"
                        >
                            &times;
                        </button>
                        <div className="flex flex-col items-center">
                            <i className={`${icon} text-4xl mb-4`}></i>
                            <p className="text-lg font-semibold mb-4">{message}</p>
                        </div>
                    </div>
                </div>
            );
        }

        // --- NOVO COMPONENTE: LandingPage (Página de Aterrissagem) ---
        function LandingPage({ onNavigate }) {
            return (
                <div className="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-4">
                    {/* Hero Section */}
                    <section className="text-center py-16 px-4 max-w-4xl mx-auto">
                        <h1 className="text-5xl md:text-6xl font-extrabold text-green-400 mb-6 leading-tight animate-fade-in-down">
                            Transforme Seus Leads em Lucro com HotLead Dashboard
                        </h1>
                        <p className="text-xl md:text-2xl text-gray-300 mb-10 max-w-2xl mx-auto animate-fade-in">
                            Sua plataforma completa para gerenciar, automatizar e otimizar suas vendas e campanhas de marketing de forma inteligente.
                        </p>
                        <div className="flex flex-col sm:flex-row justify-center gap-6 animate-fade-in-up">
                            <button
                                onClick={() => onNavigate('signup')}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-xl group"
                            >
                                <i className="fas fa-rocket mr-3 group-hover:animate-bounce"></i> Comece Agora
                            </button>
                            <button
                                onClick={() => onNavigate('login')}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-xl group"
                            >
                                <i className="fas fa-sign-in-alt mr-3 group-hover:animate-pulse"></i> Já sou Cliente
                            </button>
                        </div>
                    </section>

                    {/* Features Section */}
                    <section className="bg-gray-800 w-full py-16 px-4 rounded-lg shadow-2xl mt-12">
                        <h2 className="text-4xl font-bold text-center text-blue-400 mb-12">O que você pode fazer com HotLead?</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 max-w-6xl mx-auto">
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-dollar-sign text-5xl text-green-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Gestão de Vendas Simplificada</h3>
                                <p className="text-gray-300">Rastreie seus PIX gerados, pagamentos confirmados e faturamento total em tempo real.</p>
                            </div>
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-robot text-5xl text-purple-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Bots Inteligentes e Automatizados</h3>
                                <p className="text-gray-300">Crie e gerencie bots para automatizar interações, qualificar leads e escalar seu atendimento.</p>
                            </div>
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-bullhorn text-5xl text-orange-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Análise Detalhada de Campanhas</h3>
                                <p className="text-gray-300">Monitore o desempenho de suas campanhas e anúncios Meta (Facebook/Instagram Ads) com métricas claras.</p>
                            </div>
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-plug text-5xl text-cyan-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Integrações Essenciais</h3>
                                <p className="text-gray-300">Conecte-se facilmente a plataformas de pagamento (Pushin Pay) e outras ferramentas de marketing.</p>
                            </div>
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-shopping-cart text-5xl text-pink-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Criação de Checkouts Otimizados</h3>
                                <p className="text-gray-300">Desenvolva páginas de checkout de alta conversão para seus produtos e serviços.</p>
                            </div>
                            <div className="bg-gray-700 p-8 rounded-lg shadow-xl text-center border border-gray-600 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                                <i className="fas fa-chart-pie text-5xl text-yellow-400 mb-4"></i>
                                <h3 className="text-2xl font-semibold text-white mb-3">Relatórios e Insights Acionáveis</h3>
                                <p className="text-gray-300">Obtenha uma visão clara do seu ROI e tome decisões baseadas em dados para crescer.</p>
                            </div>
                        </div>
                    </section>

                    {/* Final Call to Action */}
                    <section className="text-center py-16 px-4 max-w-4xl mx-auto mt-12">
                        <h2 className="text-4xl md:text-5xl font-extrabold text-green-400 mb-6">
                            Pronto para Alavancar Suas Vendas?
                        </h2>
                        <p className="text-xl md:text-2xl text-gray-300 mb-10">
                            Junte-se a centenas de empreendedores que estão transformando seus negócios com HotLead Dashboard.
                        </p>
                        <div className="flex flex-col sm:flex-row justify-center gap-6">
                            <button
                                onClick={() => onNavigate('signup')}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-xl group"
                            >
                                <i className="fas fa-rocket mr-3 group-hover:animate-bounce"></i> Comece Agora
                            </button>
                            <button
                                onClick={() => onNavigate('login')}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-xl group"
                            >
                                <i className="fas fa-sign-in-alt mr-3 group-hover:animate-pulse"></i> Já sou Cliente
                            </button>
                        </div>
                    </section>
                </div>
            );
        }

        // --- NOVO COMPONENTE: LoginPage ---
        function LoginPage({ onLoginSuccess, onSignUpClick, showMessage }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();

                // TODO: Chamar endpoint de login do seu backend
                // Exemplo de como seria a chamada (adapte para seu backend):
                // const response = await fetch('/api/auth/login', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ email, password })
                // });
                // const data = await response.json();

                // if (response.ok) {
                //     localStorage.setItem('userToken', data.token); // Salva o token de autenticação
                //     onLoginSuccess(); // Notifica o App que o login foi bem-sucedido
                // } else {
                //     showMessage(data.message || 'Erro ao fazer login. Verifique suas credenciais.', 'error');
                // }

                // SIMULAÇÃO DE LOGIN BEM-SUCEDIDO (REMOVER EM PRODUÇÃO)
                if (email === 'teste@teste.com' && password === '123456') {
                    localStorage.setItem('userToken', 'mock_token_123'); // Simula token
                    showMessage('Login realizado com sucesso!', 'success');
                    onLoginSuccess();
                } else {
                    showMessage('Email ou senha inválidos (simulação).', 'error');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
                    <div className="bg-gray-800 p-10 rounded-lg shadow-2xl text-center max-w-md w-full border border-green-500">
                        <h2 className="text-4xl font-extrabold text-green-400 mb-6">Login</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="block text-gray-300 text-left text-sm font-bold mb-2">Email:</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="seuemail@exemplo.com"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-gray-300 text-left text-sm font-bold mb-2">Senha:</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="Sua senha"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-lg"
                            >
                                <i className="fas fa-sign-in-alt mr-3"></i> Entrar
                            </button>
                        </form>
                        <p className="mt-6 text-gray-400">
                            Não tem uma conta?{' '}
                            <button onClick={onSignUpClick} className="text-blue-500 hover:underline font-semibold">
                                Cadastre-se
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- NOVO COMPONENTE: SignUpPage ---
        function SignUpPage({ onSignUpSuccess, onLoginClick, showMessage }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');

            const handleSignUp = async (e) => {
                e.preventDefault();

                if (password !== confirmPassword) {
                    showMessage('As senhas não coincidem!', 'error');
                    return;
                }
                if (password.length < 6) { // Exemplo de validação
                    showMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
                    return;
                }

                // TODO: Chamar endpoint de criar conta do seu backend
                // Exemplo de como seria a chamada (adapte para seu backend):
                // const response = await fetch('/api/auth/signup', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ name, email, password })
                // });
                // const data = await response.json();

                // if (response.ok) {
                //     showMessage('Conta criada com sucesso! Faça login.', 'success');
                //     onSignUpSuccess(); // Redireciona para a página de login
                // } else {
                //     showMessage(data.message || 'Erro ao criar conta. Tente novamente.', 'error');
                // }

                // SIMULAÇÃO DE CRIAÇÃO DE CONTA BEM-SUCEDIDA (REMOVER EM PRODUÇÃO)
                if (email.includes('@') && password === confirmPassword) {
                    showMessage('Conta criada com sucesso (simulação)! Agora faça login.', 'success');
                    onSignUpSuccess(); // Redireciona para login
                } else {
                    showMessage('Verifique os campos e tente novamente (simulação).', 'error');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
                    <div className="bg-gray-800 p-10 rounded-lg shadow-2xl text-center max-w-md w-full border border-blue-500">
                        <h2 className="text-4xl font-extrabold text-blue-400 mb-6">Criar Conta</h2>
                        <form onSubmit={handleSignUp} className="space-y-6">
                            <div>
                                <label htmlFor="name" className="block text-gray-300 text-left text-sm font-bold mb-2">Nome Completo:</label>
                                <input
                                    type="text"
                                    id="name"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Seu nome"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="email" className="block text-gray-300 text-left text-sm font-bold mb-2">Email:</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="seuemail@exemplo.com"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-gray-300 text-left text-sm font-bold mb-2">Senha:</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Mínimo 6 caracteres"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="confirmPassword" className="block text-gray-300 text-left text-sm font-bold mb-2">Confirmar Senha:</label>
                                <input
                                    type="password"
                                    id="confirmPassword"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Confirme sua senha"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-lg"
                            >
                                <i className="fas fa-user-plus mr-3"></i> Criar Conta
                            </button>
                        </form>
                        <p className="mt-6 text-gray-400">
                            Já tem uma conta?{' '}
                            <button onClick={onLoginClick} className="text-green-500 hover:underline font-semibold">
                                Faça Login
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD Componente (1 - Atualizado para buscar vendas reais e gastos diários reais) ---
        function Dashboard({ showMessage }) {
            // Declarações de estado e ref movidas para o topo para clareza
            const [chartData, setChartData] = useState({ labels: [], datasets: [] });
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [allSalesData, setAllSalesData] = useState([]); // Armazena todos os dados de vendas da API
            const [filteredSalesData, setFilteredSalesData] = useState([]); // Dados de vendas filtrados para exibição
            const [campaignsDailySpendData, setCampaignsDailySpendData] = useState([]); // Dados de gastos diários das campanhas (agregados por todas as contas)
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            console.log("Dashboard component rendered. chartData:", chartData); // Log para depuração

            // ATENÇÃO: SUBSTITUA ESTE TOKEN PELO SEU TOKEN DE ACESSO VÁLIDO DA META ADS API.
            // MANTER TOKENS DIRETAMENTE NO CÓDIGO DO CLIENTE NÃO É SEGURO PARA PRODUÇÃO.
            const TOKEN = "EAAIyWkoZCTyQBPCoNeC8WZCqICBf3L4uFY60QXTZAzYvuP9MrSR4RYuA1II4TwtrxFmtOrdLdKbdsZAloc1qUfuzz0kKgsxZCW2acLTr2oEcrrufvwMbMSAmjS7I2YBtgcHWbiXIyZBSXjS0jt7vNxhUsZAmidBTM2w2ZANOGk6kIy9VueXNUwPmJSPWMFMWcbNVAbMrsso4yNZB1iNJqzDjX"; // Seu token de acesso da Meta Ads API aqui
            const API_BASE_URL = 'https://hotlead-api-production.up.railway.app/api';
            const API_KEY = '715fdc00-ff3c-4180-bf4c-287783841da7';

            // Função para buscar TODOS os dados de vendas da API
            const fetchAllSales = useCallback(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/sales?page=1&per_page=1000`, { // Usando per_page=1000 para buscar mais dados
                        method: 'GET',
                        headers: {
                            'x-api-key': API_KEY,
                            'Content-Type': 'application/json',
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("Dados brutos da API de Vendas (Dashboard):", data); // Log para depuração
                    // Validar se data.data existe e é um array
                    if (data && Array.isArray(data.data)) {
                        setAllSalesData(data.data);
                        if (data.data.length === 0) {
                            showMessage("A API de vendas do Dashboard retornou 0 vendas. Verifique os dados no banco de dados.", 'info');
                        }
                    } else {
                        throw new Error("Formato de dados da API de vendas do Dashboard inesperado. 'data.data' não é um array.");
                    }
                } catch (e) {
                    console.error("Erro ao buscar todas as vendas para o dashboard:", e);
                    showMessage(`Erro ao carregar dados de vendas: ${e.message}`, 'error');
                    setAllSalesData([]);
                }
            }, [showMessage]);

            // Função para buscar e agregar métricas de gastos diários de TODAS as contas de anúncio
            const fetchAndAggregateMetaSpendData = useCallback(async (start, end) => {
                if (!TOKEN) {
                    showMessage("Token de acesso da Meta Ads API não fornecido. Por favor, insira um token válido na constante TOKEN.", 'warning');
                    setCampaignsDailySpendData([]);
                    return;
                }
                try {
                    // 1. Buscar todas as contas de anúncio do usuário
                    const adAccountsUrl = new URL(`https://graph.facebook.com/v19.0/me/adaccounts`);
                    adAccountsUrl.searchParams.set("fields", "id"); // Apenas o ID é necessário
                    adAccountsUrl.searchParams.set("access_token", TOKEN);
                    const adAccountsRes = await fetch(adAccountsUrl);
                    const adAccountsData = await adAccountsRes.json();

                    if (adAccountsData.error) {
                        throw new Error(`Erro ao buscar contas de anúncio: ${adAccountsData.error.message}`);
                    }
                    const accountIds = (adAccountsData.data || []).map(acc => acc.id);

                    if (accountIds.length === 0) {
                        showMessage("Nenhuma conta de anúncio encontrada para o token fornecido. Não é possível buscar gastos.", 'warning');
                        setCampaignsDailySpendData([]);
                        return;
                    }

                    const allDailySpends = new Map(); // Map<date_start, total_spend_for_that_day>

                    // 2. Para cada conta, buscar os insights diários e agregá-los
                    for (const account of accountIds) {
                        const insightsUrl = new URL(`https://graph.facebook.com/v19.0/${account}/insights`);
                        insightsUrl.searchParams.set("level", "account"); // Nível da conta para gastos totais diários
                        insightsUrl.searchParams.set("fields", "spend");
                        insightsUrl.searchParams.set("time_range", JSON.stringify({ since: start, until: end }));
                        insightsUrl.searchParams.set("time_increment", "1"); // Solicita dados diários
                        insightsUrl.searchParams.set("access_token", TOKEN);

                        const res = await fetch(insightsUrl);
                        const data = await res.json();

                        if (data.error) {
                            console.warn(`Erro ao buscar insights para conta ${account}: ${data.error.message}`);
                            // Continua para a próxima conta se uma falhar
                            continue;
                        }

                        (data.data || []).forEach(insight => {
                            const dateKey = insight.date_start;
                            const currentSpend = allDailySpends.get(dateKey) || 0;
                            allDailySpends.set(dateKey, currentSpend + parseFloat(insight.spend || 0));
                        });
                    }

                    // Converter o mapa de volta para o formato de array esperado
                    const aggregatedDailySpends = Array.from(allDailySpends.entries()).map(([date_start, spend]) => ({
                        date_start,
                        spend: spend.toFixed(2) // Mantém como string com 2 casas decimais
                    })).sort((a,b) => new Date(a.date_start) - new Date(b.date_start)); // Ordena por data

                    console.log("Dados de gastos diários agregados (Dashboard):", aggregatedDailySpends); // Log para depuração
                    setCampaignsDailySpendData(aggregatedDailySpends);

                } catch (e) {
                    console.error("Erro ao buscar e agregar gastos diários para o dashboard:", e);
                    showMessage(`Erro ao carregar gastos de campanhas: ${e.message}. Verifique seu token de acesso da Meta Ads API.`, 'error');
                    setCampaignsDailySpendData([]);
                }
            }, [TOKEN, showMessage]);

            // Efeito inicial para carregar dados
            useEffect(() => {
                const today = new Date();
                const lastMonth = new Date(today);
                lastMonth.setDate(today.getDate() - 30);

                const defaultEndDate = today.toISOString().slice(0, 10);
                const defaultStartDate = lastMonth.toISOString().slice(0, 10);

                setStartDate(defaultStartDate);
                setEndDate(defaultEndDate);
                
                fetchAllSales(); // Busca todas as vendas
                fetchAndAggregateMetaSpendData(defaultStartDate, defaultEndDate); // Busca e agrega gastos com filtro de data
            }, [fetchAllSales, fetchAndAggregateMetaSpendData]);

            // Efeito para filtrar os dados de vendas sempre que allSalesData ou as datas mudarem
            useEffect(() => {
                console.log("Filtrando dados de vendas para Dashboard...");
                const startObj = new Date(startDate + 'T00:00:00Z');
                const endObj = new Date(endDate + 'T23:59:59Z');

                const filtered = allSalesData.filter(sale => {
                    // Usando sale.generate_date conforme a API
                    const saleDate = new Date(sale.generate_date);
                    return saleDate >= startObj && saleDate <= endObj;
                });
                console.log("Dados de vendas filtrados (Dashboard):", filtered); // Log para depuração
                setFilteredSalesData(filtered);
            }, [allSalesData, startDate, endDate]);


            // Lógica para preparar dados para o gráfico
            useEffect(() => {
                if (filteredSalesData.length === 0 && campaignsDailySpendData.length === 0) {
                    setChartData({ labels: [], datasets: [] });
                    return;
                }

                const datesMap = new Map();
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Inicializa todas as datas no intervalo
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateKey = d.toISOString().slice(0, 10);
                    datesMap.set(dateKey, { sales: 0, spending: 0 });
                }

                // Agrega dados de vendas filtrados (valores em centavos)
                filteredSalesData.forEach(sale => {
                    const saleDateKey = new Date(sale.generate_date).toISOString().slice(0, 10); // Usando sale.generate_date
                    if (datesMap.has(saleDateKey)) {
                        datesMap.get(saleDateKey).sales += sale.value; // Adiciona o valor em centavos
                    }
                });

                // Agrega dados de gastos diários reais (valores em moeda)
                campaignsDailySpendData.forEach(insight => {
                    const dateKey = insight.date_start; // date_start é 'YYYY-MM-DD'
                    if (datesMap.has(dateKey)) {
                        datesMap.get(dateKey).spending += parseFloat(insight.spend || 0) * 100; // Converte para centavos para consistência
                    }
                });
                
                const labels = Array.from(datesMap.keys()).map(dateKey => {
                    const [year, month, day] = dateKey.split('-');
                    return `${day}/${month}`;
                });

                const salesValues = Array.from(datesMap.values()).map(data => data.sales);
                const spendingValues = Array.from(datesMap.values()).map(data => data.spending);
                const profitValues = Array.from(datesMap.values()).map(data => data.sales - data.spending);

                setChartData({
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas (Vendas)',
                            data: salesValues,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: 'Saídas (Gastos)',
                            data: spendingValues,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: 'Lucro Diário',
                            data: profitValues,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            tension: 0.3,
                            fill: false,
                            borderDash: [5, 5],
                        },
                    ],
                });
            }, [filteredSalesData, campaignsDailySpendData, startDate, endDate]);

            // Efeito para renderizar/atualizar o gráfico Chart.js
            useEffect(() => {
                console.log("Attempting to render chart. chartData:", chartData); // Log para depuração
                if (chartRef.current && chartData.labels.length > 0) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy(); // Destrói a instância anterior se existir
                    }
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#e0e0e0',
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Desempenho Diário (Entradas, Saídas, Lucro)',
                                    color: '#e0e0e0',
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: '#e0e0e0',
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.3)',
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#e0e0e0',
                                        callback: function(value) {
                                            // A função formatCurrency já converte de centavos para Reais para exibição
                                            return formatCurrency(value); 
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.3)',
                                    }
                                }
                            }
                        }
                    });
                } else if (chartInstance.current && chartData.labels.length === 0) {
                    // Destrói o gráfico se não houver dados
                    chartInstance.current.destroy();
                    chartInstance.current = null;
                }

                // Cleanup na desmontagem do componente
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                };
            }, [chartData]);


            // Calcula o total de vendas PAGO para o dashboard (em centavos)
            const totalSalesPaid = filteredSalesData.filter(s => s.status === 'PAGO').reduce((sum, sale) => sum + sale.value, 0);
            // Calcula o total de gastos (em centavos) a partir dos dados diários agregados de todas as contas
            const totalSpending = campaignsDailySpendData.reduce((sum, insight) => sum + parseFloat(insight.spend || 0) * 100, 0);
            const totalProfit = totalSalesPaid - totalSpending; // Lucro baseado apenas em vendas pagas (em centavos)

            // Group sales and spending by bot for per-bot metrics
            // Nota: Os dados de bots e adsets ainda seriam carregados de APIs reais em um ambiente de produção.
            // Para esta demonstração, os bots são inicializados como vazios e adicionados via UI.
            const botsMetrics = BOTS_DATA_INITIAL_STATE.map(bot => { // Usando o estado inicial de bots (vazio)
                const botSales = filteredSalesData.filter(sale => sale.model === bot.id); // Usando sale.model
                const botRevenue = botSales.reduce((sum, sale) => sum + sale.value, 0); // (em centavos)
                
                // Calcula gastos com base nas campanhas vinculadas
                // Como MOCK_ADSETS_DATA foi removido, esta parte precisaria de dados reais de adsets.
                const simulatedBotSpending = 0; // Não há dados de adsets mockados para simular gastos por bot
                // ADSETS_DATA_INITIAL_STATE.filter(adset =>
                //     bot.linkedCampaigns && bot.linkedCampaigns.includes(adset.id)
                // ).reduce((sum, adset) => sum + adset.spend, 0);

                const botProfit = botRevenue - simulatedBotSpending;
                return { ...bot, revenue: botRevenue, spending: simulatedBotSpending, profit: botProfit };
            });

            const handleApplyFilters = () => {
                // Ao clicar em "Atualizar", apenas re-filtra os dados de vendas já carregados
                // e busca novamente os dados de campanha da Meta Ads com o novo período.
                fetchAndAggregateMetaSpendData(startDate, endDate);
            };

            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Dashboard Principal</h2>

                    {/* Filters for Dashboard */}
                    <div className="flex flex-wrap items-center justify-center gap-6 mb-8 p-4 bg-gray-700 rounded-md">
                        <div className="flex flex-col">
                            <label htmlFor="dashboardStartDate" className="text-gray-300 text-sm font-medium mb-1">Data Início:</label>
                            <input
                                type="date"
                                id="dashboardStartDate"
                                value={startDate}
                                onChange={(e) => setStartDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="dashboardEndDate" className="text-gray-300 text-sm font-medium mb-1">Data Fim:</label>
                            <input
                                type="date"
                                id="dashboardEndDate"
                                value={endDate}
                                onChange={(e) => setEndDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <button
                            onClick={handleApplyFilters}
                            className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2.5 px-6 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center group"
                        >
                            <i className="fas fa-sync-alt mr-2 rotate-on-hover"></i>
                            Atualizar
                        </button>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg flex flex-col items-center justify-center text-center">
                            <i className="fas fa-dollar-sign text-5xl text-blue-400 mb-3"></i>
                            <h3 className="text-xl font-bold mb-2">Vendas Totais (Pagos)</h3>
                            <p className="text-gray-300 text-2xl font-semibold">{formatCurrency(totalSalesPaid)}</p>
                        </div>
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg flex flex-col items-center justify-center text-center">
                            <i className="fas fa-hand-holding-usd text-5xl text-red-400 mb-3"></i>
                            <h3 className="text-xl font-bold mb-2">Gastos Totais</h3>
                            <p className="text-gray-300 text-2xl font-semibold">{formatCurrency(totalSpending)}</p>
                        </div>
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg flex flex-col items-center justify-center text-center">
                            <i className="fas fa-coins text-5xl text-green-400 mb-3"></i>
                            <h3 className="text-xl font-bold mb-2">Lucro Total</h3>
                            <p className="text-gray-300 text-2xl font-semibold">{formatCurrency(totalProfit)}</p>
                        </div>
                    </div>

                    {/* Dashboard Chart */}
                    <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg mb-8">
                        <h3 className="text-2xl font-bold text-blue-300 mb-4 text-center">Desempenho Diário</h3>
                        <div className="h-80">
                            <canvas ref={chartRef} id="dailyPerformanceChart"></canvas>
                        </div>
                    </div>

                    {/* Bots Ativos Section */}
                    <h3 className="text-2xl font-bold text-blue-300 mb-4">Bots Ativos e Métricas</h3>
                    {BOTS_DATA_INITIAL_STATE.length > 0 ? ( // Verifica se há bots para exibir
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {botsMetrics.map(bot => (
                                <div key={bot.id} className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg border border-gray-500">
                                    <h4 className="text-xl font-semibold mb-2 text-white">{bot.name} ({bot.status === 'ativo' ? 'Ativo' : 'Inativo'})</h4>
                                    <div className="grid grid-cols-2 gap-y-2 text-gray-300">
                                        <p><strong>Faturamento:</strong> <span className="text-green-300">{formatCurrency(bot.revenue)}</span></p>
                                        <p><strong>Gastos:</strong> <span className="text-red-300">{formatCurrency(bot.spending)}</span></p>
                                        <p><strong>Lucro:</strong> <span className={`${bot.profit >= 0 ? 'text-green-400' : 'text-red-400'} font-bold`}>{formatCurrency(bot.profit)}</span></p>
                                        <p><strong>Vendas:</strong> <span className="text-blue-300">{filteredSalesData.filter(s => s.model === bot.id).length}</span></p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p className="text-center text-gray-400 py-4">Nenhum bot configurado. Adicione bots na página "Bots" para ver as métricas.</p>
                    )}
                </div>
            );
        }

        // --- VENDAS Componente (2 - AGORA COM API REAL E FILTRO NO FRONT) ---
        function SalesPage({ showMessage }) {
            const [allSalesData, setAllSalesData] = useState([]); // Armazena todos os dados de vendas da API
            const [filteredSales, setFilteredSales] = useState([]); // Dados de vendas filtrados para exibição
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [selectedBot, setSelectedBot] = useState('all');
            const [botsList, setBotsList] = useState([]); // Usado para popular o filtro de bots

            // API Constants
            const API_BASE_URL = 'https://hotlead-api-production.up.railway.app/api';
            const API_KEY = '715fdc00-ff3c-4180-bf4c-287783841da7';

            // Função para buscar TODOS os dados de vendas da API
            const fetchAllSales = useCallback(async () => {
                setLoading(true);
                setError(null);
                try {
                    const response = await fetch(`${API_BASE_URL}/sales?page=1&per_page=1000`, { // Usando per_page=1000 para buscar mais dados
                        method: 'GET',
                        headers: {
                            'x-api-key': API_KEY,
                            'Content-Type': 'application/json',
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("Dados brutos da API de Vendas (SalesPage):", data); // Log para depuração

                    // Validar se data.data existe e é um array
                    if (data && Array.isArray(data.data)) {
                        setAllSalesData(data.data);
                        console.log("Vendas carregadas:", data.data.length);

                        // Extrai modelos únicos para o filtro de bots
                        const uniqueModels = [...new Set(data.data.map(sale => sale.model))].map(model => ({ id: model, name: model }));
                        setBotsList(uniqueModels);

                        if (data.data.length === 0) {
                            showMessage("A API retornou 0 vendas. Verifique os dados no banco de dados ou os filtros aplicados.", 'info');
                        }
                    } else {
                        throw new Error("Formato de dados da API inesperado. 'data.data' não é um array ou está ausente.");
                    }
                } catch (e) {
                    setError(e);
                    showMessage(`Erro ao buscar vendas: ${e.message}`, 'error');
                    setAllSalesData([]);
                    setBotsList([]);
                } finally {
                    setLoading(false);
                }
            }, [showMessage]);

            // Efeito inicial para carregar todos os dados de vendas
            useEffect(() => {
                fetchAllSales();
            }, [fetchAllSales]);

            // Efeito para aplicar filtros sempre que allSalesData ou os parâmetros de filtro mudarem
            useEffect(() => {
                console.log("Filtrando dados de vendas para SalesPage...");
                const startObj = new Date(startDate + 'T00:00:00Z');
                const endObj = new Date(endDate + 'T23:59:59Z');

                const results = allSalesData.filter(sale => {
                    // Usando sale.generate_date conforme a API
                    const saleDate = new Date(sale.generate_date);
                    const isInDateRange = saleDate >= startObj && saleDate <= endObj;
                    // Usando sale.model conforme a API
                    const matchesBot = selectedBot === 'all' || sale.model === selectedBot;
                    return isInDateRange && matchesBot;
                });
                console.log("Dados de vendas filtrados (SalesPage):", results); // Log para depuração
                setFilteredSales(results.sort((a,b) => new Date(b.generate_date) - new Date(a.generate_date))); // Usando generate_date para ordenação
            }, [allSalesData, startDate, endDate, selectedBot]);

            // Define as datas padrão para os últimos 30 dias na montagem do componente
            useEffect(() => {
                const today = new Date();
                const lastMonth = new Date(today);
                lastMonth.setDate(today.getDate() - 30);

                setEndDate(today.toISOString().slice(0, 10));
                setStartDate(lastMonth.toISOString().slice(0, 10));
            }, []); // Executa apenas uma vez na montagem

            const handleFilterChange = () => {
                // A filtragem já acontece no useEffect acima quando startDate, endDate ou selectedBot mudam
                // Não é necessário chamar fetchAllSales novamente, pois os dados já estão em allSalesData
            };

            const totalPixGenerated = filteredSales.filter(s => s.status === 'AGUARDANDO_PAGAMENTO').length;
            const totalPixPaid = filteredSales.filter(s => s.status === 'PAGO').length;
            // Calcula o valor total pago em centavos e passa para formatCurrency
            const totalAmountPaid = filteredSales.filter(s => s.status === 'PAGO').reduce((sum, s) => sum + s.value, 0);

            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Relatório de Vendas</h2>

                    {/* Filters */}
                    <div className="flex flex-wrap items-center justify-center gap-6 mb-8 p-4 bg-gray-700 rounded-md">
                        <div className="flex flex-col">
                            <label htmlFor="salesStartDate" className="text-gray-300 text-sm font-medium mb-1">Data Início:</label>
                            <input
                                type="date"
                                id="salesStartDate"
                                value={startDate}
                                onChange={(e) => setStartDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="salesEndDate" className="text-gray-300 text-sm font-medium mb-1">Data Fim:</label>
                            <input
                                type="date"
                                id="salesEndDate"
                                value={endDate}
                                onChange={(e) => setEndDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="botSelect" className="text-gray-300 text-sm font-medium mb-1">Filtrar por Modelo:</label>
                            <select
                                id="botSelect"
                                value={selectedBot}
                                onChange={(e) => setSelectedBot(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            >
                                <option value="all">Todos os Modelos</option>
                                {botsList.map(bot => ( // Usando a lista de bots extraída da API
                                    <option key={bot.id} value={bot.id}>{bot.name}</option>
                                ))}
                            </select>
                        </div>
                        <button
                            onClick={handleFilterChange}
                            className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2.5 px-6 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center group"
                        >
                            <i className="fas fa-filter mr-2 rotate-on-hover"></i>
                            Aplicar Filtros
                        </button>
                    </div>

                    {/* Sales Summary */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg">
                            <h3 className="text-xl font-bold mb-2 text-blue-300">PIX Gerados</h3>
                            <p className="text-white text-3xl font-semibold">{totalPixGenerated}</p>
                        </div>
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg">
                            <h3 className="text-xl font-bold mb-2 text-green-300">PIX Pagos</h3>
                            <p className="text-white text-3xl font-semibold">{totalPixPaid}</p>
                        </div>
                        <div className="bg-gray-600 dark:bg-gray-700 p-5 rounded-md shadow-lg">
                            <h3 className="text-xl font-bold mb-2 text-purple-300">Valor Total Pago</h3>
                            <p className="text-white text-3xl font-semibold">{formatCurrency(totalAmountPaid)}</p>
                        </div>
                    </div>

                    {/* Sales List */}
                    <h3 className="text-2xl font-bold text-blue-300 mb-4">Detalhes das Vendas ({filteredSales.length} resultados)</h3>
                    <div className="table-container bg-gray-600 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                        {loading ? (
                            <p className="p-4 text-center text-gray-300"><i className="fas fa-spinner fa-spin mr-2"></i> Carregando vendas...</p>
                        ) : error ? (
                            <p className="p-4 text-center text-red-400">Erro ao carregar vendas: {error.message}</p>
                        ) : filteredSales.length === 0 ? (
                            <p className="p-4 text-center text-gray-300">Nenhuma venda encontrada para os filtros selecionados.</p>
                        ) : (
                            <table className="custom-table">
                                <thead>
                                    <tr>
                                        <th>Modelo</th>
                                        <th>Campanha</th>
                                        <th>Código PIX</th>
                                        <th>Valor</th>
                                        <th>Data Geração</th>
                                        <th>Data Pagamento</th>
                                        <th>Status</th>
                                        <th>Meta Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredSales.map(sale => (
                                        <tr key={sale.pix_code}> {/* Usando pix_code como key, pois é único */}
                                            <td>{sale.model}</td> {/* Usando sale.model */}
                                            <td>{sale.campaign}</td> {/* Usando sale.campaign */}
                                            <td>{sale.pix_code}</td> {/* Usando sale.pix_code */}
                                            <td>{formatCurrency(sale.value)}</td> {/* Usando sale.value (em centavos) */}
                                            <td>{formatDate(sale.generate_date)}</td> {/* Usando sale.generate_date */}
                                            <td>{sale.payment_date ? formatDate(sale.payment_date) : '-'}</td> {/* Usando sale.payment_date */}
                                            <td>
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${sale.status === 'PAGO' ? 'bg-green-500 text-gray-900' : 'bg-orange-500 text-gray-900'}`}>
                                                    {sale.status}
                                                </span>
                                            </td>
                                            <td>{sale.meta_status || '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        }

        // --- Componente Modal de Configuração do Bot ---
        function BotConfigurationModal({ bot, allAdAccounts, allAdSets, onClose, onSaveConfig, showMessage }) {
            const [localBot, setLocalBot] = useState(bot);
            const [loadingStatus, setLoadingStatus] = useState(false);
            const [selectedAdAccountId, setSelectedAdAccountId] = useState(bot.adAccountId || '');

            useEffect(() => {
                setLocalBot(bot); // Atualiza o estado local se o bot prop mudar
                setSelectedAdAccountId(bot.adAccountId || '');
            }, [bot]);

            const handleCampaignToggle = (adSetId) => {
                setLocalBot(prevBot => {
                    const updatedCampaigns = prevBot.linkedCampaigns.includes(adSetId)
                        ? prevBot.linkedCampaigns.filter(id => id !== adSetId)
                        : [...prevBot.linkedCampaigns, adSetId];
                    return { ...prevBot, linkedCampaigns: updatedCampaigns };
                });
            };

            const handleSave = () => {
                onSaveConfig(localBot);
                onClose();
            };

            // Função para consultar o status e nome de um bot via API do Telegram
            const checkBotStatusAndName = async (token) => {
                if (!token) {
                    return { success: false, message: 'Token do bot é obrigatório.' };
                }
                const telegramApiUrl = `https://api.telegram.org/bot${token}/getMe`;
                try {
                    const response = await fetch(telegramApiUrl);
                    const data = await response.json();

                    if (data.ok && data.result) {
                        return {
                            success: true,
                            name: data.result.first_name || 'Nome não definido',
                            status: 'ativo',
                            message: `Bot "${data.result.first_name || 'Nome não definido'}" está ativo.`,
                        };
                    } else {
                        return {
                            success: false,
                            name: 'Desconhecido', // Se não for ok, o nome é desconhecido
                            status: 'inativo',
                            message: `Bot inativo ou Erro: ${data.description || 'Desconhecido'}`,
                        };
                    }
                } catch (error) {
                    console.error('Erro ao consultar API do Telegram:', error);
                    return {
                        success: false,
                        name: 'Desconhecido',
                        status: 'inativo',
                        message: `Erro de conexão com a API do Telegram.`,
                    };
                }
            };

            const handleConsultStatus = async () => {
                setLoadingStatus(true);
                const result = await checkBotStatusAndName(localBot.token);
                setLoadingStatus(null);

                if (result.success) {
                    setLocalBot(prevBot => ({ ...prevBot, name: result.name, status: result.status }));
                    showMessage(`Status do bot "${result.name}" atualizado: ${result.status}!`, 'success');
                } else {
                    setLocalBot(prevBot => ({ ...prevBot, status: result.status }));
                    showMessage(`Erro ao consultar status: ${result.message}`, 'error');
                }
            };

            // Filter ad sets based on selectedAdAccountId
            // allAdSets agora virá de um estado vazio, então filteredAdSets também será vazio
            const filteredAdSets = allAdSets.filter(adset => adset.account_id === selectedAdAccountId);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl w-full text-gray-100 relative">
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl"
                        >
                            &times;
                        </button>
                        <h2 className="text-3xl font-bold text-green-400 mb-6 text-center">Configurar Bot: {localBot.name}</h2>

                        {/* Bot Details */}
                        <div className="mb-6 p-4 bg-gray-700 rounded-md">
                            <h3 className="text-xl font-semibold text-blue-300 mb-3">Detalhes do Bot</h3>
                            <p className="mb-2"><strong>ID:</strong> {localBot.id}</p>
                            <p className="mb-2"><strong>Nome:</strong> {localBot.name}</p>
                            <p className="mb-2"><strong>Token:</strong> <span className="font-mono text-sm break-all">{localBot.token}</span></p>
                            <p className="mb-4">
                                <strong>Status:</strong>{' '}
                                <span className={`px-2 py-1 rounded-full text-sm font-semibold ${localBot.status === 'ativo' ? 'bg-green-500 text-gray-900' : 'bg-red-500 text-white'}`}>
                                    {localBot.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                </span>
                            </p>
                            <button
                                onClick={handleConsultStatus}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-300 flex items-center justify-center"
                                disabled={loadingStatus}
                            >
                                {loadingStatus ? (
                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                ) : (
                                    <i className="fas fa-sync-alt mr-2"></i>
                                )}
                                {loadingStatus ? 'Consultando...' : 'Consultar Status Agora'}
                            </button>
                             <p className="text-yellow-400 text-xs mt-3">
                                <i className="fas fa-exclamation-triangle mr-1"></i> A consulta direta à API do Telegram no navegador expõe seu token.
                            </p>
                        </div>

                        {/* Select Ad Account */}
                        <div className="mb-6 p-4 bg-gray-700 rounded-md">
                            <h3 className="text-xl font-semibold text-blue-300 mb-3">Vincular Conta de Anúncios</h3>
                            <select
                                value={selectedAdAccountId}
                                onChange={(e) => {
                                    setSelectedAdAccountId(e.target.value);
                                    // Clear linked campaigns if account changes, as they might not be relevant anymore
                                    setLocalBot(prevBot => ({ ...prevBot, linkedCampaigns: [], adAccountId: e.target.value }));
                                }}
                                className="w-full bg-gray-600 border border-gray-500 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            >
                                <option value="">Selecione uma Conta de Anúncios</option>
                                {/* allAdAccounts agora é um array vazio, então este dropdown estará vazio */}
                                {allAdAccounts.map(account => (
                                    <option key={account.id} value={account.id}>
                                        {account.name} (ID: {account.id})
                                    </option>
                                ))}
                            </select>
                            {!selectedAdAccountId && <p className="text-red-400 text-sm mt-2">Por favor, selecione uma conta de anúncios para vincular campanhas.</p>}
                            <p className="text-gray-400 text-sm mt-3">
                                <i className="fas fa-info-circle mr-1"></i> As contas de anúncios precisam ser carregadas de uma API real.
                            </p>
                        </div>


                        {/* Link Campaigns (Ad Sets) */}
                        <div className="mb-6 p-4 bg-gray-700 rounded-md">
                            <h3 className="text-xl font-semibold text-blue-300 mb-3">Vincular Campanhas (Ad Sets)</h3>
                            {selectedAdAccountId ? (
                                filteredAdSets.length > 0 ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2">
                                        {filteredAdSets.map(adSet => (
                                            <label key={adSet.id} className="flex items-center text-gray-300 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={localBot.linkedCampaigns.includes(adSet.id)}
                                                    onChange={() => handleCampaignToggle(adSet.id)}
                                                    className="form-checkbox h-5 w-5 text-green-600 rounded border-gray-500 focus:ring-green-500 bg-gray-600"
                                                />
                                                <span className="ml-2 text-base">{adSet.name}</span>
                                            </label>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-400">Nenhum conjunto de anúncios encontrado para a conta selecionada.</p>
                                )
                            ) : (
                                <p className="text-gray-400">Selecione uma conta de anúncios acima para ver as campanhas disponíveis.</p>
                            )}
                            <p className="text-gray-400 text-sm mt-3">
                                <i className="fas fa-info-circle mr-1"></i> Os conjuntos de anúncios precisam ser carregados de uma API real da Meta.
                            </p>
                        </div>

                        {/* Action Buttons */}
                        <div className="flex justify-end gap-4 mt-6">
                            <button
                                onClick={onClose}
                                className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleSave}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300"
                            >
                                Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
            );
        }


        // --- BOTS Componente (3) ---
        function BotsPage({ showMessage }) {
            const [bots, setBots] = useState(BOTS_DATA_INITIAL_STATE); // Inicia com estado vazio
            const [newBotToken, setNewBotToken] = useState('');
            const [loadingBotId, setLoadingBotId] = useState(null); // Para indicar qual bot está sendo consultado
            const [selectedBot, setSelectedBot] = useState(null); // Bot selecionado para configuração
            const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);

            // Função para consultar o status e nome de um bot via API do Telegram
            const checkBotStatusAndName = async (token) => {
                if (!token) {
                    return { success: false, message: 'Token do bot é obrigatório.' };
                }
                const telegramApiUrl = `https://api.telegram.org/bot${token}/getMe`;
                try {
                    const response = await fetch(telegramApiUrl);
                    const data = await response.json();

                    if (data.ok && data.result) {
                        return {
                            success: true,
                            name: data.result.first_name || 'Nome não definido',
                            status: 'ativo',
                            message: `Bot "${data.result.first_name || 'Nome não definido'}" está ativo.`,
                        };
                    } else {
                        return {
                            success: false,
                            name: 'Desconhecido', // Se não for ok, o nome é desconhecido
                            status: 'inativo',
                            message: `Bot inativo ou token inválido: ${data.description || 'Erro desconhecido.'}`,
                        };
                    }
                } catch (error) {
                    console.error('Erro ao consultar API do Telegram:', error);
                    return {
                        success: false,
                        name: 'Desconhecido',
                        status: 'inativo',
                        message: `Erro de conexão com a API do Telegram.`,
                    };
                }
            };

            // Recalcula métricas dos bots sempre que houver mudança nos dados simulados
            const botsWithMetrics = bots.map(bot => {
                const botSales = []; // Vendas reais por bot precisariam de uma API de vendas que filtre por modelo de bot
                const botRevenue = botSales.reduce((sum, sale) => sum + sale.value, 0); // (em centavos)

                // Calcula gastos com base nas campanhas vinculadas
                // Como MOCK_ADSETS_DATA foi removido, esta parte precisaria de dados reais de adsets.
                const simulatedBotSpending = 0; // Não há dados de adsets mockados para simular gastos por bot
                // ADSETS_DATA_INITIAL_STATE.filter(adset =>
                //     bot.linkedCampaigns && bot.linkedCampaigns.includes(adset.id)
                // ).reduce((sum, adset) => sum + adset.spend, 0);

                const botProfit = botRevenue - simulatedBotSpending;
                return { ...bot, revenue: botRevenue, spending: simulatedBotSpending, profit: botProfit };
            });

            const handleAddBot = async (e) => {
                e.preventDefault();
                if (newBotToken.trim() === '') {
                    showMessage('Token do bot é obrigatório!', 'error');
                    return;
                }

                setLoadingBotId('new'); // Indica que estamos carregando para o novo bot
                const result = await checkBotStatusAndName(newBotToken.trim());
                setLoadingBotId(null);

                if (result.success) {
                    const newBot = {
                        id: result.name, // Usar o nome do bot como ID para simplificar (em produção, seria um ID único)
                        name: result.name,
                        status: result.status,
                        token: newBotToken.trim(),
                        linkedCampaigns: [], // Novos bots começam sem campanhas vinculadas
                        adAccountId: '' // Novo bot começa sem conta de anúncio vinculada
                    };
                    setBots(prevBots => [...prevBots, newBot]); // Add to local state (not persistent for mock)
                    setNewBotToken('');
                    showMessage(`Bot "${result.name}" adicionado com sucesso e está ${result.status}!`, 'success');
                } else {
                    showMessage(`Erro ao adicionar bot: ${result.message}`, 'error');
                }
            };

            const handleOpenConfigModal = (bot) => {
                setSelectedBot(bot);
                setIsConfigModalOpen(true);
            };

            const handleCloseConfigModal = () => {
                setSelectedBot(null);
                setIsConfigModalOpen(false);
            };

            const handleSaveBotConfig = (updatedBot) => {
                setBots(prevBots =>
                    prevBots.map(bot =>
                        bot.id === updatedBot.id ? updatedBot : bot
                    )
                );
                showMessage(`Configurações do bot "${updatedBot.name}" salvas com sucesso!`, 'success');
            };

            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Gestão de Bots</h2>

                    {/* Aviso de Segurança */}
                    <div className="bg-yellow-700 text-yellow-100 p-4 rounded-md mb-6 text-center shadow-md">
                        <i className="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Aviso de Segurança:</strong> A consulta direta à API do Telegram no navegador expõe seu token. Em um ambiente de produção, esta operação deve ser feita através de um servidor backend seguro.
                    </div>

                    {/* Add New Bot Form */}
                    <div className="mb-8 p-6 bg-gray-600 dark:bg-gray-700 rounded-md shadow-inner">
                        <h3 className="text-xl font-bold text-blue-300 mb-4">Adicionar Novo Bot (via Token Telegram)</h3>
                        <form onSubmit={handleAddBot} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-grow flex flex-col">
                                <label htmlFor="newBotToken" className="text-gray-300 text-sm font-medium mb-1">Token do Bot Telegram:</label>
                                <input
                                    type="text"
                                    id="newBotToken"
                                    placeholder="Ex: 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                                    value={newBotToken}
                                    onChange={(e) => setNewBotToken(e.target.value)}
                                    className="flex-grow bg-gray-500 border border-gray-400 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                                disabled={loadingBotId === 'new'}
                            >
                                {loadingBotId === 'new' ? (
                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                ) : (
                                    <i className="fas fa-plus mr-2"></i>
                                )}
                                {loadingBotId === 'new' ? 'Adicionando...' : 'Adicionar Bot'}
                            </button>
                        </form>
                        <p className="text-gray-400 text-sm mt-3">
                            <i className="fas fa-info-circle mr-1"></i> Bots adicionados aqui não serão persistidos sem um backend.
                        </p>
                    </div>

                    {/* Bots List */}
                    <h3 className="text-2xl font-bold text-blue-300 mb-4">Bots Ativos e Inativos ({bots.length})</h3>
                    <div className="table-container bg-gray-600 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                        {bots.length === 0 ? (
                            <p className="p-4 text-center text-gray-300">Nenhum bot configurado. Adicione um bot usando o formulário acima.</p>
                        ) : (
                            <table className="custom-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>ID</th>
                                        <th>Status</th>
                                        <th>Faturamento</th>
                                        <th>Gastos</th>
                                        <th>Lucro</th>
                                        <th>Campanhas Vinculadas</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {botsWithMetrics.map(bot => (
                                        <tr key={bot.id} className="cursor-pointer hover:bg-gray-700" onClick={() => handleOpenConfigModal(bot)}>
                                            <td className="truncate-text max-w-[180px]">{bot.name}</td>
                                            <td className="truncate-text max-w-[120px]">{bot.id}</td>
                                            <td>
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${bot.status === 'ativo' ? 'bg-green-500 text-gray-900' : 'bg-red-500 text-white'}`}>
                                                    {bot.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                                </span>
                                            </td>
                                            <td>{formatCurrency(bot.revenue)}</td>
                                            <td>{formatCurrency(bot.spending)}</td>
                                            <td><span className={`${bot.profit >= 0 ? 'text-green-400' : 'text-red-400'} font-bold`}>{formatCurrency(bot.profit)}</span></td>
                                            <td>
                                                {bot.linkedCampaigns && bot.linkedCampaigns.length > 0 ? (
                                                    <ul className="list-disc list-inside text-sm text-gray-300">
                                                        {/* allAdSets agora é um estado vazio, então não haverá nomes de campanha */}
                                                        {bot.linkedCampaigns.map(campaignId => {
                                                            // const campaign = ADSETS_DATA_INITIAL_STATE.find(c => c.id === campaignId);
                                                            return <li key={campaignId} className="truncate-text max-w-[150px]">{campaignId}</li>;
                                                        })}
                                                    </ul>
                                                ) : (
                                                    <span className="text-gray-400 text-sm italic">Nenhuma</span>
                                                )}
                                            </td>
                                            <td>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); handleOpenConfigModal(bot); }}
                                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                                                >
                                                    <i className="fas fa-cog mr-1"></i> Configurar
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {isConfigModalOpen && selectedBot && (
                        <BotConfigurationModal
                            bot={selectedBot}
                            allAdAccounts={AD_ACCOUNTS_INITIAL_STATE} // Passa o estado vazio
                            allAdSets={ADSETS_DATA_INITIAL_STATE} // Passa o estado vazio
                            onClose={handleCloseConfigModal}
                            onSaveConfig={handleSaveBotConfig}
                            showMessage={showMessage}
                        />
                    )}
                </div>
            );
        }

        // --- INTEGRAÇÕES Componente (5) ---
        function IntegrationsPage({ showMessage }) {
            const [pixelId, setPixelId] = useState('');
            const [adsAccountConnected, setAdsAccountConnected] = useState(false); // Simulate connection status
            const [pushinPayToken, setPushinPayToken] = useState(''); // Estado para o token da Pushin Pay

            const handleSavePixel = (e) => {
                e.preventDefault();
                showMessage(`Pixel ID ${pixelId} salvo (apenas UI)! Em um sistema real, isso seria enviado para o backend.`, 'info');
                // Here you would typically send pixelId to your backend
            };

            const handleConnectAdsAccount = () => {
                // IMPORTANT: This is a UI placeholder.
                // Connecting a Meta Ads account securely involves OAuth 2.0 (e.g., Facebook Login for Business)
                // where the user grants permissions and you receive an access token on your backend.
                // It CANNOT be done purely in frontend HTML/JS dueato security implications and complexity.
                showMessage('Iniciando conexão da Conta de Anúncios Meta Ads (simulação). Isso exigiria um fluxo OAuth completo com um backend.', 'warning');
                setAdsAccountConnected(true); // Simulate success for UI
            };

            const handleSavePushinPayToken = (e) => {
                e.preventDefault();
                if (pushinPayToken.trim() === '') {
                    showMessage('O token da Pushin Pay é obrigatório!', 'error');
                    return;
                }
                showMessage(`Token da Pushin Pay salvo (apenas UI)! Em um sistema real, isso seria enviado para o backend para processar pagamentos.`, 'success');
                // Aqui você enviaria o pushinPayToken para o seu backend
            };

            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Integrações de Marketing e Pagamento</h2>

                    {/* Meta Pixel Setup */}
                    <div className="mb-8 p-6 bg-gray-600 dark:bg-gray-700 rounded-md shadow-inner">
                        <h3 className="text-xl font-bold text-blue-300 mb-4 flex items-center"><i className="fab fa-facebook-f mr-3 text-2xl"></i> Configuração do Pixel Meta</h3>
                        <form onSubmit={handleSavePixel} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-grow flex flex-col">
                                <label htmlFor="pixelId" className="text-gray-300 text-sm font-medium mb-1">ID do Pixel Meta:</label>
                                <input
                                    type="text"
                                    id="pixelId"
                                    placeholder="Ex: 1234567890"
                                    value={pixelId}
                                    onChange={(e) => setPixelId(e.target.value)}
                                    className="bg-gray-500 border border-gray-400 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                />
                            </div>
                            <button
                                type="submit"
                                className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 transform hover:scale-105"
                            >
                                <i className="fas fa-save mr-2"></i> Salvar Pixel
                            </button>
                        </form>
                    </div>

                    {/* Meta Ads Account Consent */}
                    <div className="mb-8 p-6 bg-gray-600 dark:bg-gray-700 rounded-md shadow-inner">
                        <h3 className="text-xl font-bold text-blue-300 mb-4 flex items-center"><i className="fab fa-facebook-square mr-3 text-2xl"></i> Conectar Conta de Anúncios Meta</h3>
                        <p className="text-gray-300 mb-4">
                            Para puxar as métricas de suas campanhas e anúncios, precisamos da sua permissão para acessar sua conta de anúncios Meta.
                            **Atenção: A conexão real envolve um fluxo de autenticação seguro (OAuth) entre o seu servidor e a Meta. Este é apenas um placeholder de UI.**
                        </p>
                        {adsAccountConnected ? (
                            <div className="flex items-center text-green-400 text-lg font-semibold">
                                <i className="fas fa-check-circle mr-3"></i> Conta de Anúncios Conectada!
                            </div>
                        ) : (
                            <button
                                onClick={handleConnectAdsAccount}
                                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 transform hover:scale-105"
                            >
                                <i className="fas fa-link mr-2"></i> Conectar Conta Meta Ads
                            </button>
                        )}
                    </div>

                    {/* Pushin Pay Integration */}
                    <div className="p-6 bg-gray-600 dark:bg-gray-700 rounded-md shadow-inner">
                        <h3 className="text-xl font-bold text-blue-300 mb-4 flex items-center"><i className="fas fa-credit-card mr-3 text-2xl"></i> Integração Pushin Pay</h3>
                        <p className="text-gray-300 mb-4">
                            Insira seu token da Pushin Pay para permitir que nosso backend processe pagamentos e consulte o status dos PIX gerados.
                            **Aviso: Por segurança, o processamento de pagamentos e a consulta de status devem ser realizados exclusivamente pelo seu backend, utilizando este token de forma segura.**
                        </p>
                        <form onSubmit={handleSavePushinPayToken} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-grow flex flex-col">
                                <label htmlFor="pushinPayToken" className="text-gray-300 text-sm font-medium mb-1">Token da Pushin Pay:</label>
                                <input
                                    type="text"
                                    id="pushinPayToken"
                                    placeholder="Seu token secreto da Pushin Pay"
                                    value={pushinPayToken}
                                    onChange={(e) => setPushinPayToken(e.target.value)}
                                    className="bg-gray-500 border border-gray-400 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2 px-6 rounded-md shadow-md transition-all duration-300 transform hover:scale-105"
                            >
                                <i className="fas fa-save mr-2"></i> Salvar Token
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- CRIAR CHECKOUT (6) ---
        function CreateCheckout() {
            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Página de Criar Checkout</h2>
                    <p className="text-gray-300 text-center">Aqui você poderá configurar e criar novos checkouts para seus produtos.</p>
                    <p className="text-gray-400 text-center mt-4">Funcionalidade a ser desenvolvida.</p>
                </div>
            );
        }

        // --- CAMPANHAS Componente (7) ---
        function CampaignsPage({ showMessage }) {
            const [campaigns, setCampaigns] = useState([]);
            const [adsets, setAdsets] = useState([]);
            const [ads, setAds] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [adAccounts, setAdAccounts] = useState([]); // Estado para armazenar as contas de anúncio reais
            const [selectedAccountId, setSelectedAccountId] = useState(''); // Conta de anúncio selecionada
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [activeTab, setActiveTab] = useState('campaigns');
            const [selectedCampaign, setSelectedCampaign] = useState(null); // Novo estado para a campanha clicada

            // ATENÇÃO: SUBSTITUA ESTE TOKEN PELO SEU TOKEN DE ACESSO VÁLIDO DA META ADS API.
            // MANTER TOKENS DIRETAMENTE NO CÓDIGO DO CLIENTE NÃO É SEGURO PARA PRODUÇÃO.
            const TOKEN = "EAAIyWkoZCTyQBPCoNeC8WZCqICBf3L4uFY60QXTZAzYvuP9MrSR4RYuA1II4TwtrxFmtOrdLdKbdsZAloc1qUfuzz0kKgsxZCW2acLTr2oEcrrufvwMbMSAmjS7I2YBtgcHWbiXIyZBSXjS0jt7vNxhUsZAmidBTM2w2ZANOGk6kIy9VueXNUwPmJSPWMFMWcbNVAbMrsso4yNZB1iNJqzDjX"; // Seu token de acesso da Meta Ads API aqui

            const renderStatus = useCallback((status) => {
                if (!status) return null;
                status = status.toLowerCase();
                let colorClass = '';
                if (status.includes("active")) colorClass = 'bg-green-500 text-gray-900';
                else if (status.includes("paused")) colorClass = 'bg-orange-500 text-gray-900';
                else if (status.includes("inactive") || status.includes("archived") || status.includes("completed") || status.includes("deleted")) colorClass = 'bg-red-500 text-white';
                return (
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${colorClass}`}>
                        {status.replace(/_/g, ' ')}
                    </span>
                );
            }, []);

            const renderActions = useCallback((actions) => {
                if (!actions || !actions.length) return <p className="text-gray-400 text-sm italic">Sem ações registradas</p>;
                const labels = {
                    "link_click": "Cliques em Links", "post_engagement": "Engajamento Post", "page_engagement": "Engajamento Página",
                    "lead": "Leads", "purchase": "Compras", "view_content": "Visualizações", "add_to_cart": "Add Carrinho",
                    "initiate_checkout": "Início Checkout"
                };
                return (
                    <div className="mt-3 pt-3 border-t border-gray-700">
                        <p className="font-semibold text-gray-300 mb-2">Ações:</p>
                        {actions.map((a, index) => (
                            <p key={index} className="text-sm text-gray-400 flex items-center mb-1">
                                <i className="fas fa-dot-circle text-green-500 mr-2"></i>
                                {labels[a.action_type] || a.action_type}: <strong className="ml-1 text-gray-200">{a.value}</strong>
                            </p>
                        ))}
                    </div>
                );
            }, []);

            // Função para buscar as contas de anúncio do usuário
            const fetchAdAccounts = useCallback(async () => {
                if (!TOKEN) {
                    showMessage("Token de acesso da Meta Ads API não fornecido. Por favor, insira um token válido na constante TOKEN.", 'warning');
                    setAdAccounts([]);
                    return;
                }
                try {
                    const url = new URL(`https://graph.facebook.com/v19.0/me/adaccounts`);
                    url.searchParams.set("fields", "id,name");
                    url.searchParams.set("access_token", TOKEN);
                    const res = await fetch(url);
                    const data = await res.json();
                    console.log("Raw ad account data:", data); // Debugging
                    if (data.error) throw new Error(`API Contas de Anúncio: ${data.error.message}`);
                    setAdAccounts(data.data || []);
                    // Define a primeira conta como selecionada por padrão, se houver
                    if (data.data && data.data.length > 0) {
                        console.log("First ad account ID:", data.data[0].id); // Debugging
                        setSelectedAccountId(data.data[0].id);
                    }
                } catch (err) {
                    console.error("Erro ao carregar contas de anúncio:", err);
                    showMessage(`Erro ao carregar contas de anúncio: ${err.message}. Verifique seu token de acesso da Meta Ads API.`, 'error');
                    setAdAccounts([]);
                }
            }, [TOKEN, showMessage]);


            const fetchCampaignsData = useCallback(async (currentAccountId, since, until) => {
                if (!TOKEN) {
                    showMessage("Token de acesso da Meta Ads API não fornecido. Por favor, insira um token válido na constante TOKEN.", 'warning');
                    setCampaigns([]);
                    setAdsets([]);
                    setAds([]);
                    return;
                }
                if (!currentAccountId) {
                    setCampaigns([]);
                    setAdsets([]);
                    setAds([]);
                    return;
                }

                setLoading(true);
                setError(null);
                try {
                    // Ensure the accountId is just the numeric part
                    const cleanAccountId = currentAccountId.startsWith('act_') ? currentAccountId.substring(4) : currentAccountId;
                    console.log("Fetching data for clean account ID:", cleanAccountId); // Debugging

                    // Fetch Campaigns and their insights
                    const urlCampaigns = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/campaigns`);
                    urlCampaigns.searchParams.set("fields", "id,name,status,effective_status,start_time,stop_time");
                    urlCampaigns.searchParams.set("limit", "200");
                    urlCampaigns.searchParams.set("access_token", TOKEN);

                    const urlCampaignInsights = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/insights`);
                    urlCampaignInsights.searchParams.set("level", "campaign");
                    urlCampaignInsights.searchParams.set("fields", "campaign_id,impressions,clicks,spend,actions,ctr,cpc,cpm");
                    urlCampaignInsights.searchParams.set("time_range", JSON.stringify({ since, until }));
                    urlCampaignInsights.searchParams.set("limit", "500");
                    urlCampaignInsights.searchParams.set("access_token", TOKEN); // Corrected: ensure access_token is set

                    // Fetch Ad Sets and their insights
                    const urlAdsets = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/adsets`);
                    urlAdsets.searchParams.set("fields", "id,name,status,effective_status,campaign_id,objective,start_time,stop_time");
                    urlAdsets.searchParams.set("limit", "200");
                    urlAdsets.searchParams.set("access_token", TOKEN); // Corrected: ensure access_token is set

                    const urlAdsetInsights = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/insights`);
                    urlAdsetInsights.searchParams.set("level", "adset");
                    urlAdsetInsights.searchParams.set("fields", "adset_id,impressions,clicks,spend,actions,ctr,cpc,cpm");
                    urlAdsetInsights.searchParams.set("time_range", JSON.stringify({ since, until }));
                    urlAdsetInsights.searchParams.set("limit", "500");
                    urlAdsetInsights.searchParams.set("access_token", TOKEN); // Corrected: ensure access_token is set

                    // Fetch Ads and their insights
                    const urlAds = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/ads`);
                    urlAds.searchParams.set("fields", "id,name,status,effective_status,adset_id,preview_url");
                    urlAds.searchParams.set("limit", "200");
                    urlAds.searchParams.set("access_token", TOKEN); // Corrected: ensure access_token is set

                    const urlAdInsights = new URL(`https://graph.facebook.com/v19.0/act_${cleanAccountId}/insights`);
                    urlAdInsights.searchParams.set("level", "ad");
                    urlAdInsights.searchParams.set("fields", "ad_id,impressions,clicks,spend,actions,ctr,cpc,cpm");
                    urlAdInsights.searchParams.set("time_range", JSON.stringify({ since, until }));
                    urlAdInsights.searchParams.set("limit", "500");
                    urlAdInsights.searchParams.set("access_token", TOKEN); // Corrected: ensure access_token is set


                    const [
                        campRes, campInsightsRes,
                        adsetRes, adsetInsightsRes,
                        adsRes, adsInsightsRes
                    ] = await Promise.all([
                        fetch(urlCampaigns), fetch(urlCampaignInsights),
                        fetch(urlAdsets), fetch(urlAdsetInsights),
                        fetch(urlAds), fetch(urlAdInsights)
                    ]);

                    const campData = await campRes.json();
                    const campInsightsData = await campInsightsRes.json();
                    const adsetData = await adsetRes.json();
                    const adsetInsightsData = await adsetInsightsRes.json();
                    const adsData = await adsRes.json();
                    const adsInsightsData = await adsInsightsRes.json();

                    if (campData.error) throw new Error(`API Campanhas: ${campData.error.message}`);
                    if (campInsightsData.error) throw new Error(`API Insights Campanhas: ${campInsightsData.error.message}`);
                    if (adsetData.error) throw new Error(`API Conjuntos de Anúncios: ${adsetData.error.message}`);
                    if (adsetInsightsData.error) throw new Error(`API Insights Conjuntos de Anúncios: ${adsetInsightsData.error.message}`);
                    if (adsData.error) throw new Error(`API Anúncios: ${adsData.error.message}`);
                    if (adsInsightsData.error) throw new Error(`API Insights Anúncios: ${adsInsightsData.error.message}`);

                    // Combine campaigns with their insights
                    const campInsightsMap = {};
                    (campInsightsData.data || []).forEach(i => { campInsightsMap[i.campaign_id] = i; });
                    const combinedCampaigns = (campData.data || []).map(camp => ({
                        ...camp,
                        insights: campInsightsMap[camp.id] || {}
                    }));
                    setCampaigns(combinedCampaigns);

                    // Combine ad sets with their insights
                    const adsetInsightsMap = {};
                    (adsetInsightsData.data || []).forEach(i => { adsetInsightsMap[i.adset_id] = i; });
                    const combinedAdsets = (adsetData.data || []).map(adset => ({
                        ...adset,
                        insights: adsetInsightsMap[adset.id] || {}
                    }));
                    setAdsets(combinedAdsets);

                    // Combine ads with their insights
                    const adsInsightsMap = {};
                    (adsInsightsData.data || []).forEach(i => { adsInsightsMap[i.ad_id] = i; });
                    const combinedAds = (adsData.data || []).map(ad => ({
                        ...ad,
                        insights: adsInsightsMap[ad.id] || {}
                    }));
                    setAds(combinedAds);

                } catch (err) {
                    setError(err.message);
                    console.error("Erro ao carregar dados de campanhas/adsets/ads:", err);
                    showMessage(`Erro ao carregar dados: ${err.message}. Verifique seu token de acesso da Meta Ads API.`, 'error');
                } finally {
                    setLoading(false);
                }
            }, [TOKEN, showMessage]);

            useEffect(() => {
                // Carrega as contas de anúncio na montagem do componente
                fetchAdAccounts();

                const today = new Date();
                const lastWeek = new Date(today);
                lastWeek.setDate(today.getDate() - 7);

                const defaultEndDate = today.toISOString().slice(0, 10);
                const defaultStartDate = lastWeek.toISOString().slice(0, 10); // Define a data de início para o começo do dia

                setStartDate(defaultStartDate);
                setEndDate(defaultEndDate);
            }, [fetchAdAccounts]);

            // Efeito para buscar dados de campanhas quando a conta selecionada ou as datas mudam
            useEffect(() => {
                if (selectedAccountId && startDate && endDate) {
                    fetchCampaignsData(selectedAccountId, startDate, endDate);
                }
            }, [selectedAccountId, startDate, endDate, fetchCampaignsData]);


            const handleRefresh = () => {
                if (!selectedAccountId || !startDate || !endDate) {
                    showMessage("Por favor, selecione a conta e as datas.", 'warning');
                    return;
                }
                // Reseta a campanha selecionada ao atualizar os dados gerais
                setSelectedCampaign(null);
                fetchCampaignsData(selectedAccountId, startDate, endDate);
            };

            const handleCampaignClick = (campaign) => {
                setSelectedCampaign(campaign);
                setActiveTab('adsets'); // Mudar para a aba de conjuntos de anúncios ao clicar na campanha
            };

            const handleBackToAllCampaigns = () => {
                setSelectedCampaign(null);
                setActiveTab('campaigns'); // Volta para a aba de campanhas
            };

            const renderDataCards = (data, type) => {
                let displayData = data;
                let title = '';

                if (selectedCampaign) {
                    if (type === 'campaigns') {
                        // If a campaign is selected, only show that campaign in the 'campaigns' tab
                        displayData = [selectedCampaign];
                        title = `Campanha Selecionada: ${selectedCampaign.name}`;
                    } else if (type === 'adsets') {
                        // Filter adsets by the selected campaign's ID
                        displayData = adsets.filter(adset => adset.campaign_id === selectedCampaign.id);
                        title = `Conjuntos de Anúncios da Campanha: ${selectedCampaign.name}`;
                    } else if (type === 'ads') {
                        // First, get all adset IDs associated with the selected campaign
                        const campaignAdsetIds = adsets
                            .filter(adset => adset.campaign_id === selectedCampaign.id)
                            .map(adset => adset.id);
                        // Then, filter ads by these adset IDs
                        displayData = ads.filter(ad => campaignAdsetIds.includes(ad.adset_id));
                        title = `Criativos da Campanha: ${selectedCampaign.name}`;
                    }
                } else {
                    // If no campaign is selected, show all data for the current tab
                    if (type === 'campaigns') title = 'Todas as Campanhas';
                    else if (type === 'adsets') title = 'Todos os Conjuntos de Anúncios';
                    else if (type === 'ads') title = 'Todos os Criativos';
                }

                if (displayData.length === 0) {
                    return <p className="text-center text-gray-400 py-8">Nenhum {type === 'campaigns' ? 'Campanha' : type === 'adsets' ? 'Conjunto de Anúncio' : 'Criativo'} encontrado(a) para o período e conta selecionados{selectedCampaign ? ` na campanha "${selectedCampaign.name}"` : ''}.</p>;
                }

                return (
                    <div className="bg-gray-700 rounded-lg shadow-md p-5 border border-gray-600">
                        <h3 className="text-2xl font-bold text-blue-300 mb-4 text-center">{title}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {displayData.map(item => (
                                <div
                                    key={item.id}
                                    className={`bg-gray-800 rounded-lg shadow-md p-5 border border-gray-600 transition-transform duration-300 hover:scale-105 hover:shadow-xl ${type === 'campaigns' ? 'cursor-pointer' : ''}`}
                                    onClick={type === 'campaigns' ? () => handleCampaignClick(item) : null}
                                >
                                    <h3 className="text-xl font-semibold text-blue-300 mb-2 truncate-text">{item.name || item.id}</h3>
                                    {item.status && <div className="mb-3 flex flex-wrap gap-2">{renderStatus(item.status)} {item.effective_status && item.status !== item.effective_status && renderStatus(item.effective_status)}</div>}
                                    <p className="text-sm text-gray-300 mb-1"><strong>ID:</strong> <span className="text-gray-200">{item.id}</span></p>
                                    {item.start_time && <p className="text-sm text-gray-300 mb-1"><strong>Início:</strong> <span className="text-gray-200">{formatDate(item.start_time)}</span></p>}
                                    {item.stop_time && <p className="text-sm text-gray-300 mb-3"><strong>Fim:</strong> <span className="text-gray-200">{item.stop_time ? formatDate(item.stop_time) : 'Em aberto'}</span></p>}
                                    {item.objective && <p className="text-sm text-gray-300 mb-1"><strong>Objetivo:</strong> <span className="text-gray-200">{item.objective.replace(/_/g, ' ')}</span></p>}
                                    {item.preview_url && (
                                        <div className="mb-3">
                                            <p className="text-sm text-gray-300 mb-1"><strong>Prévia:</strong></p>
                                            <img src={item.preview_url} alt="Creative Preview" className="w-full h-auto max-h-48 object-cover rounded-md mt-2" />
                                            <a href={item.preview_url} target="_blank" rel="noopener noreferrer" className="text-blue-400 text-sm hover:underline mt-1 block">Ver Imagem/Vídeo</a>
                                        </div>
                                    )}


                                    <div className="mt-4 pt-4 border-t border-gray-600">
                                        <h4 className="font-bold text-lg text-green-400 mb-2">Métricas ({formatDate(startDate)} - {formatDate(endDate)})</h4>
                                        <p className="text-gray-300 text-base mb-1"><strong>Gastos:</strong> <span className="text-red-300 font-semibold">{formatCurrency(parseFloat(item.insights.spend || 0) * 100)}</span></p> {/* Multiplica por 100 para passar em centavos */}
                                        <p className="text-gray-300 text-base mb-1"><strong>Cliques:</strong> <span className="text-blue-300 font-semibold">{item.insights.clicks || 0}</span></p>
                                        <p className="text-gray-300 text-base mb-1"><strong>Impressões:</strong> <span className="text-purple-300 font-semibold">{item.insights.impressions || 0}</span></p>
                                        <p className="text-gray-300 text-base mb-1"><strong>CTR:</strong> <span className="text-orange-300 font-semibold">{(parseFloat(item.insights.ctr || 0)).toFixed(2)}%</span></p>
                                        <p className="text-gray-300 text-base mb-1"><strong>CPC:</strong> <span className="text-cyan-300 font-semibold">{formatCurrency(parseFloat(item.insights.cpc || 0) * 100)}</span></p> {/* Multiplica por 100 */}
                                        <p className="text-gray-300 text-base mb-1"><strong>CPM:</strong> <span className="text-pink-300 font-semibold">{formatCurrency(parseFloat(item.insights.cpm || 0) * 100)}</span></p> {/* Multiplica por 100 */}
                                        {renderActions(item.insights.actions)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="bg-gray-700 dark:bg-gray-800 p-8 rounded-lg shadow-xl text-gray-100 mb-8">
                    <h2 className="text-3xl font-extrabold text-green-400 mb-6 text-center">Gestão de Campanhas Meta Ads</h2>

                    {/* Filters and Account Selection */}
                    <div className="flex flex-wrap items-center justify-center gap-6 mb-8 p-4 bg-gray-700 rounded-md">
                        <div className="flex flex-col">
                            <label htmlFor="accountSelect" className="text-gray-300 text-sm font-medium mb-1">Conta de Anúncio:</label>
                            <select
                                id="accountSelect"
                                value={selectedAccountId}
                                onChange={(e) => setSelectedAccountId(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            >
                                <option value="">Selecione uma Conta de Anúncios</option>
                                {adAccounts.map(account => (
                                    <option key={account.id} value={account.id}>
                                        {account.name} (ID: {account.id})
                                    </option>
                                ))}
                            </select>
                            {adAccounts.length === 0 && (
                                <p className="text-yellow-400 text-sm mt-1">
                                    <i className="fas fa-exclamation-triangle mr-1"></i> Nenhuma conta de anúncio encontrada. Verifique suas permissões ou token.
                                </p>
                            )}
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="startDate" className="text-gray-300 text-sm font-medium mb-1">Data Início:</label>
                            <input
                                type="date"
                                id="startDate"
                                value={startDate}
                                onChange={(e) => setStartDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <div className="flex flex-col">
                            <label htmlFor="endDate" className="text-gray-300 text-sm font-medium mb-1">Data Fim:</label>
                            <input
                                type="date"
                                id="endDate"
                                value={endDate}
                                onChange={(e) => setEndDate(e.target.value)}
                                className="bg-gray-600 border border-gray-500 text-white py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 cursor-pointer"
                            />
                        </div>
                        <button
                            onClick={handleRefresh}
                            className="bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-2.5 px-6 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center group"
                        >
                            <i className="fas fa-sync-alt mr-2 rotate-on-hover"></i>
                            Atualizar Dados
                        </button>
                    </div>

                    {selectedCampaign && (
                        <div className="mb-6 text-center">
                            <button
                                onClick={handleBackToAllCampaigns}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-md shadow-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                            >
                                <i className="fas fa-arrow-left mr-2"></i> Voltar para Todas as Campanhas
                            </button>
                        </div>
                    )}

                    {/* Tabs for Campaigns, Ad Sets, Ads */}
                    <div className="flex justify-center mb-8 bg-gray-700 p-2 rounded-lg shadow-inner">
                        <button
                            onClick={() => setActiveTab('campaigns')}
                            className={`flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-300 ${activeTab === 'campaigns' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600 hover:text-white'}`}
                        >
                            <i className="fas fa-bullhorn mr-2"></i> Campanhas
                        </button>
                        <button
                            onClick={() => setActiveTab('adsets')}
                            className={`flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-300 ${activeTab === 'adsets' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600 hover:text-white'}`}
                        >
                            <i className="fas fa-layer-group mr-2"></i> Conjuntos de Anúncios
                        </button>
                        <button
                            onClick={() => setActiveTab('ads')}
                            className={`flex-1 py-3 px-4 rounded-md text-sm font-medium transition-all duration-300 ${activeTab === 'ads' ? 'bg-green-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-600 hover:text-white'}`}
                        >
                            <i className="fas fa-ad mr-2"></i> Criativos
                        </button>
                    </div>

                    {loading && (
                        <div className="text-center py-10">
                            <i className="fas fa-spinner fa-spin text-green-400 text-4xl mb-4"></i>
                            <p className="text-gray-300 text-lg">Carregando dados da Meta Ads...</p>
                        </div>
                    )}
                    {error && (
                        <div className="bg-red-800 text-red-100 p-4 rounded-md text-center">
                            <i className="fas fa-exclamation-triangle mr-2"></i>
                            <p>Erro ao carregar dados: {error}</p>
                            <p className="text-sm mt-2">Verifique seu token de acesso, permissões ou a conexão de internet.</p>
                        </div>
                    )}

                    {!loading && !error && (
                        <div>
                            {activeTab === 'campaigns' && renderDataCards(campaigns, 'campaigns')}
                            {activeTab === 'adsets' && renderDataCards(adsets, 'adsets')}
                            {activeTab === 'ads' && renderDataCards(ads, 'ads')}
                        </div>
                    )}
                </div>
            );
        }

        // --- NOVO COMPONENTE: FlowCreatorPage ---
        function FlowCreatorPage() {
            const [flow, setFlow] = useState({
                blocks: [],
                selectedBlockId: null,
            });

            const flowCanvasRef = useRef(null);
            const flowCanvasWrapperRef = useRef(null);
            const flowLinesSvgRef = useRef(null);
            const propertiesPanelRef = useRef(null);

            // Refs for properties panel elements
            const messageTextRef = useRef(null);
            const imageUploadInputRef = useRef(null);
            const videoUploadInputRef = useRef(null);
            const audioUploadInputRef = useRef(null);
            const messageNextBlockSelectRef = useRef(null);

            const requestMethodSelectRef = useRef(null);
            const requestUrlInputRef = useRef(null);
            const requestBodyTextareaRef = useRef(null);
            const requestNextBlockSelectRef = useRef(null);

            const conditionLogicOperatorSelectRef = useRef(null);
            const conditionNextTrueSelectRef = useRef(null);
            const conditionNextFalseSelectRef = useRef(null);


            // Canvas Panning State
            const [isDraggingCanvas, setIsDraggingCanvas] = useState(false);
            const [canvasTranslate, setCanvasTranslate] = useState({ x: 0, y: 0 });
            const dragStartCoords = useRef({ x: 0, y: 0 });

            // --- Utility Functions ---
            const generateId = useCallback(() => {
                return 'block_' + Math.random().toString(36).substr(2, 9);
            }, []);

            const showFeedback = useCallback((message, type = 'info') => {
                const feedbackMessageDiv = document.getElementById('flow-creator-page-feedback-message');
                if (feedbackMessageDiv) {
                    feedbackMessageDiv.textContent = message;
                    feedbackMessageDiv.className = `show ${type}`;
                    setTimeout(() => {
                        feedbackMessageDiv.classList.remove('show');
                    }, 3000);
                }
            }, []);

            const createBlockElement = useCallback((block) => {
                const blockElement = document.createElement('div');
                blockElement.className = 'flow-block';
                blockElement.id = block.id;
                blockElement.style.left = `${block.x}px`;
                blockElement.style.top = `${block.y}px`;

                let iconClass = '';
                let blockTitle = '';
                let contentHtml = '';
                let mediaHtml = '';

                switch (block.type) {
                    case 'start':
                        iconClass = 'fas fa-play';
                        blockTitle = 'Início';
                        contentHtml = `<p>${block.data.messageText || 'Ponto de entrada do fluxo.'}</p>`;
                        break;
                    case 'message':
                        iconClass = 'fas fa-comment-dots';
                        blockTitle = 'Mensagem';
                        contentHtml = `<p>${block.data.messageText || 'Mensagem do bot.'}</p>`;

                        if (block.data.imageDataUrl) {
                            mediaHtml += `
                                <div class="block-media">
                                    <img src="${block.data.imageDataUrl}" alt="Imagem" onerror="this.onerror=null;this.src='https://placehold.co/100x100/3a3a3a/b0b0b0?text=IMG';" />
                                    <p>Imagem</p>
                                </div>
                            `;
                        }
                        if (block.data.videoDataUrl) {
                            mediaHtml += `
                                <div class="block-media">
                                    <i class="fas fa-video media-icon"></i>
                                    <p>Vídeo</p>
                                </div>
                            `;
                        }
                        if (block.data.audioDataUrl) {
                            mediaHtml += `
                                <div class="block-media">
                                    <i class="fas fa-volume-up media-icon"></i>
                                    <p>Áudio</p>
                                </div>
                            `;
                        }

                        if (block.data.buttons && block.data.buttons.length > 0) {
                            contentHtml += '<div class="block-buttons">';
                            block.data.buttons.forEach(button => {
                                contentHtml += `<div class="block-button">${button.text}</div>`;
                            });
                            contentHtml += '</div>';
                        }
                        if (block.data.nextBlockId) {
                            const nextBlock = flow.blocks.find(b => b.id === block.data.nextBlockId);
                            if (nextBlock) {
                                contentHtml += `<p style="font-size:12px; color:#7a7a7a; margin-top:10px;">Próximo: ${nextBlock.name || nextBlock.id}</p>`;
                            }
                        }
                        break;
                    case 'request':
                        iconClass = 'fas fa-cloud-upload-alt';
                        blockTitle = 'Requisição HTTP';
                        contentHtml = `
                            <p style="font-size:13px; color:#b0b0b0;">Método: ${block.data.method || 'N/A'}</p>
                            <p style="font-size:13px; color:#b0b0b0; word-break: break-all;">URL: ${block.data.url ? block.data.url.substring(0, 30) + (block.data.url.length > 30 ? '...' : '') : 'N/A'}</p>
                        `;
                        if (block.data.nextBlockId) {
                            const nextBlock = flow.blocks.find(b => b.id === block.data.nextBlockId);
                            if (nextBlock) {
                                contentHtml += `<p style="font-size:12px; color:#7a7a7a; margin-top:10px;">Próximo: ${nextBlock.name || nextBlock.id}</p>`;
                            }
                        }
                        break;
                    case 'condition':
                        iconClass = 'fas fa-question-circle';
                        blockTitle = 'Condição';
                        const logicOp = block.data.logicOperator === 'and' ? 'Todas' : 'Qualquer';
                        contentHtml = `<p style="font-size:13px; color:#b0b0b0;">${logicOp} condição(ões):</p>`;
                        if (block.data.conditions && block.data.conditions.length > 0) {
                            block.data.conditions.forEach(cond => {
                                contentHtml += `<p style="font-size:12px; color:#b0b0b0; margin-left:10px;">- ${cond.variable1 || 'Var'} ${cond.operator || '=='} ${cond.value2 || 'Val'}</p>`;
                            });
                        } else {
                            contentHtml += `<p style="font-size:12px; color:#7a7a7a; margin-left:10px;">Nenhuma condição definida.</p>`;
                        }

                        if (block.data.nextBlockIdTrue) {
                            const nextBlock = flow.blocks.find(b => b.id === block.data.nextBlockIdTrue);
                            if (nextBlock) {
                                contentHtml += `<p style="font-size:12px; color:#7a7a7a; margin-top:5px;">Verdadeiro: ${nextBlock.name || nextBlock.id}</p>`;
                            }
                        }
                        if (block.data.nextBlockIdFalse) {
                            const nextBlock = flow.blocks.find(b => b.id === block.data.nextBlockIdFalse);
                            if (nextBlock) {
                                contentHtml += `<p style="font-size:12px; color:#7a7a7a;">Falso: ${nextBlock.name || nextBlock.id}</p>`;
                            }
                        }
                        break;
                }

                blockElement.innerHTML = `
                    <div class="block-header">
                        <i class="${iconClass}"></i>
                        <h4>${blockTitle}</h4>
                    </div>
                    <div class="block-content">
                        ${mediaHtml}
                        ${contentHtml}
                    </div>
                `;

                blockElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectBlock(block.id);
                });

                let isBlockDragging = false;
                let dragOffsetX, dragOffsetY;

                blockElement.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        isBlockDragging = true;
                        dragOffsetX = e.clientX - blockElement.getBoundingClientRect().left;
                        dragOffsetY = e.clientY - blockElement.getBoundingClientRect().top;
                        blockElement.style.cursor = 'grabbing';
                    }
                });

                flowCanvasRef.current.addEventListener('mousemove', (e) => {
                    if (isBlockDragging) {
                        const canvasRect = flowCanvasRef.current.getBoundingClientRect();
                        let newX = e.clientX - canvasRect.left - dragOffsetX;
                        let newY = e.clientY - canvasRect.top - dragOffsetY;

                        setFlow(prevFlow => {
                            const updatedBlocks = prevFlow.blocks.map(b =>
                                b.id === block.id ? { ...b, x: newX, y: newY } : b
                            );
                            return { ...prevFlow, blocks: updatedBlocks };
                        });
                    }
                });

                flowCanvasRef.current.addEventListener('mouseup', () => {
                    if (isBlockDragging) {
                        isBlockDragging = false;
                        blockElement.style.cursor = 'pointer';
                        saveFlow();
                    }
                });

                return blockElement;
            }, [flow.blocks, selectBlock, saveFlow]); // Added flow.blocks as dependency

            const renderFlow = useCallback(() => {
                if (!flowCanvasRef.current || !flowLinesSvgRef.current) return;

                flowCanvasRef.current.innerHTML = '';
                flowCanvasRef.current.appendChild(flowLinesSvgRef.current);

                flow.blocks.forEach(block => {
                    const blockElement = createBlockElement(block);
                    flowCanvasRef.current.appendChild(blockElement);
                });
                drawConnections();
                updatePropertiesPanel();
            }, [flow.blocks, createBlockElement, drawConnections, updatePropertiesPanel]);

            const addBlock = useCallback((type, name, x, y) => {
                const newBlock = {
                    id: generateId(),
                    name: name,
                    type: type,
                    x: x,
                    y: y,
                    data: {}
                };

                if (type === 'message' || type === 'start') {
                    newBlock.data = {
                        messageText: '',
                        buttons: [],
                        nextBlockId: '',
                        imageDataUrl: '',
                        videoDataUrl: '',
                        audioDataUrl: ''
                    };
                } else if (type === 'request') {
                    newBlock.data = {
                        method: 'GET',
                        url: '',
                        headers: [],
                        body: '',
                        responseMapping: [],
                        nextBlockId: ''
                    };
                } else if (type === 'condition') {
                    newBlock.data = {
                        logicOperator: 'and',
                        conditions: [{ variable1: '', operator: '==', value2: '' }],
                        nextBlockIdTrue: '',
                        nextBlockIdFalse: ''
                    };
                }

                setFlow(prevFlow => ({
                    ...prevFlow,
                    blocks: [...prevFlow.blocks, newBlock],
                    selectedBlockId: newBlock.id
                }));
                showFeedback(`Bloco '${name}' adicionado!`, 'success');
            }, [generateId, showFeedback]);

            const selectBlock = useCallback((id) => {
                setFlow(prevFlow => ({ ...prevFlow, selectedBlockId: id }));
                const allBlocks = flowCanvasRef.current ? flowCanvasRef.current.querySelectorAll('.flow-block') : [];
                allBlocks.forEach(block => block.classList.remove('selected'));

                const selectedElement = document.getElementById(id);
                if (selectedElement) {
                    selectedElement.classList.add('selected');
                }
            }, []);

            const deleteSelectedBlock = useCallback(() => {
                if (!flow.selectedBlockId) return;

                const selectedBlock = flow.blocks.find(b => b.id === flow.selectedBlockId);
                if (selectedBlock && selectedBlock.type === 'start') {
                    showFeedback('Não é possível excluir o bloco de Início.', 'error');
                    return;
                }

                setFlow(prevFlow => {
                    const updatedBlocks = prevFlow.blocks.map(block => {
                        if (block.data) {
                            if (block.data.nextBlockId === prevFlow.selectedBlockId) {
                                block.data.nextBlockId = '';
                            }
                            if (block.data.nextBlockIdTrue === prevFlow.selectedBlockId) {
                                block.data.nextBlockIdTrue = '';
                            }
                            if (block.data.nextBlockIdFalse === prevFlow.selectedBlockId) {
                                block.data.nextBlockIdFalse = '';
                            }
                        }
                        return block;
                    }).filter(block => block.id !== prevFlow.selectedBlockId);
                    return { ...prevFlow, blocks: updatedBlocks, selectedBlockId: null };
                });
                saveFlow();
                showFeedback('Bloco excluído com sucesso!', 'success');
            }, [flow.selectedBlockId, flow.blocks, showFeedback, saveFlow]);

            const updatePropertiesPanel = useCallback(() => {
                const selectedBlock = flow.blocks.find(block => block.id === flow.selectedBlockId);
                const noBlockSelectedMessage = propertiesPanelRef.current.querySelector('#no-block-selected-message');
                const blockPropertiesContent = propertiesPanelRef.current.querySelector('#block-properties-content');
                const blockIdDisplay = propertiesPanelRef.current.querySelector('#block-id-display');
                const blockTypeDisplay = propertiesPanelRef.current.querySelector('#block-type-display');

                const messageBlockProperties = propertiesPanelRef.current.querySelector('#message-block-properties');
                const requestBlockProperties = propertiesPanelRef.current.querySelector('#request-block-properties');
                const conditionBlockProperties = propertiesPanelRef.current.querySelector('#condition-block-properties');
                const buttonsList = propertiesPanelRef.current.querySelector('#buttons-list');
                const requestHeadersList = propertiesPanelRef.current.querySelector('#request-headers-list');
                const responseMappingList = propertiesPanelRef.current.querySelector('#response-mapping-list');
                const conditionsList = propertiesPanelRef.current.querySelector('#conditions-list');
                const deleteBlockBtn = propertiesPanelRef.current.querySelector('#delete-block');


                if (selectedBlock) {
                    noBlockSelectedMessage.style.display = 'none';
                    blockPropertiesContent.style.display = 'block';

                    blockIdDisplay.value = selectedBlock.id;
                    blockTypeDisplay.value = selectedBlock.type.charAt(0).toUpperCase() + selectedBlock.type.slice(1);

                    messageBlockProperties.style.display = (selectedBlock.type === 'message' || selectedBlock.type === 'start') ? 'block' : 'none';
                    requestBlockProperties.style.display = (selectedBlock.type === 'request') ? 'block' : 'none';
                    conditionBlockProperties.style.display = (selectedBlock.type === 'condition') ? 'block' : 'none';

                    if (selectedBlock.type === 'message' || selectedBlock.type === 'start') {
                        if (messageTextRef.current) messageTextRef.current.value = selectedBlock.data.messageText || '';
                        renderButtons(selectedBlock.data.buttons, buttonsList);
                        populateNextBlockSelect(messageNextBlockSelectRef.current, selectedBlock.id, selectedBlock.data.nextBlockId);

                        if (imageUploadInputRef.current) imageUploadInputRef.current.value = '';
                        if (videoUploadInputRef.current) videoUploadInputRef.current.value = '';
                        if (audioUploadInputRef.current) audioUploadInputRef.current.value = '';

                    } else if (selectedBlock.type === 'request') {
                        if (requestMethodSelectRef.current) requestMethodSelectRef.current.value = selectedBlock.data.method || 'GET';
                        if (requestUrlInputRef.current) requestUrlInputRef.current.value = selectedBlock.data.url || '';
                        renderHeaders(selectedBlock.data.headers, requestHeadersList);
                        if (requestBodyTextareaRef.current) requestBodyTextareaRef.current.value = selectedBlock.data.body || '';
                        renderResponseMapping(selectedBlock.data.responseMapping, responseMappingList);
                        populateNextBlockSelect(requestNextBlockSelectRef.current, selectedBlock.id, selectedBlock.data.nextBlockId);
                    } else if (selectedBlock.type === 'condition') {
                        if (conditionLogicOperatorSelectRef.current) conditionLogicOperatorSelectRef.current.value = selectedBlock.data.logicOperator || 'and';
                        renderConditions(selectedBlock.data.conditions, conditionsList);
                        populateNextBlockSelect(conditionNextTrueSelectRef.current, selectedBlock.id, selectedBlock.data.nextBlockIdTrue);
                        populateNextBlockSelect(conditionNextFalseSelectRef.current, selectedBlock.id, selectedBlock.data.nextBlockIdFalse);
                    }

                    deleteBlockBtn.style.display = (selectedBlock.type === 'start') ? 'none' : 'block';

                } else {
                    noBlockSelectedMessage.style.display = 'block';
                    blockPropertiesContent.style.display = 'none';
                }
            }, [flow.selectedBlockId, flow.blocks, renderButtons, renderHeaders, renderResponseMapping, renderConditions]);


            const renderButtons = useCallback((buttons, buttonsListElement) => {
                buttonsListElement.innerHTML = '';
                buttons.forEach((button, index) => {
                    const buttonItem = document.createElement('div');
                    buttonItem.className = 'button-item';
                    buttonItem.innerHTML = `
                        <input type="text" value="${button.text}" placeholder="Texto do Botão" data-index="${index}">
                        <button class="remove-button-btn" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    buttonsListElement.appendChild(buttonItem);

                    buttonItem.querySelector('input').addEventListener('input', (e) => {
                        setFlow(prevFlow => {
                            const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                            if (selectedBlock && selectedBlock.data.buttons[index]) {
                                selectedBlock.data.buttons[index].text = e.target.value;
                            }
                            return { ...prevFlow, blocks: [...prevFlow.blocks] }; // Force re-render
                        });
                    });

                    buttonItem.querySelector('.remove-button-btn').addEventListener('click', (e) => {
                        setFlow(prevFlow => {
                            const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                            if (selectedBlock) {
                                selectedBlock.data.buttons.splice(index, 1);
                            }
                            return { ...prevFlow, blocks: [...prevFlow.blocks] }; // Force re-render
                        });
                        saveFlow();
                    });
                });
            }, [saveFlow]);

            const renderHeaders = useCallback((headers, requestHeadersListElement) => {
                requestHeadersListElement.innerHTML = '';
                headers.forEach((header, index) => {
                    const headerItem = document.createElement('div');
                    headerItem.className = 'header-item';
                    headerItem.innerHTML = `
                        <input type="text" value="${header.key}" placeholder="Key" data-index="${index}" data-field="key">
                        <input type="text" value="${header.value}" placeholder="Value" data-index="${index}" data-field="value">
                        <button class="remove-button-btn" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    requestHeadersListElement.appendChild(headerItem);

                    headerItem.querySelectorAll('input').forEach(input => {
                        input.addEventListener('input', (e) => {
                            setFlow(prevFlow => {
                                const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                                if (selectedBlock && selectedBlock.data.headers[index]) {
                                    selectedBlock.data.headers[index][e.target.dataset.field] = e.target.value;
                                }
                                return { ...prevFlow, blocks: [...prevFlow.blocks] };
                            });
                        });
                    });
                    headerItem.querySelector('.remove-button-btn').addEventListener('click', (e) => {
                        setFlow(prevFlow => {
                            const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                            if (selectedBlock) {
                                selectedBlock.data.headers.splice(index, 1);
                            }
                            return { ...prevFlow, blocks: [...prevFlow.blocks] };
                        });
                        saveFlow();
                    });
                });
            }, [saveFlow]);

            const renderResponseMapping = useCallback((mappings, responseMappingListElement) => {
                responseMappingListElement.innerHTML = '';
                mappings.forEach((mapping, index) => {
                    const mappingItem = document.createElement('div');
                    mappingItem.className = 'response-item';
                    mappingItem.innerHTML = `
                        <input type="text" value="${mapping.jsonPath}" placeholder="JSONPath (ex: $.data.qr_code)" data-index="${index}" data-field="jsonPath">
                        <input type="text" value="${mapping.variableName}" placeholder="Nome da Variável (ex: qr_code)" data-index="${index}" data-field="variableName">
                        <button class="remove-button-btn" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    responseMappingListElement.appendChild(mappingItem);

                    mappingItem.querySelectorAll('input').forEach(input => {
                        input.addEventListener('input', (e) => {
                            setFlow(prevFlow => {
                                const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                                if (selectedBlock && selectedBlock.data.responseMapping[index]) {
                                    selectedBlock.data.responseMapping[index][e.target.dataset.field] = e.target.value;
                                }
                                return { ...prevFlow, blocks: [...prevFlow.blocks] };
                            });
                        });
                    });
                    mappingItem.querySelector('.remove-button-btn').addEventListener('click', (e) => {
                        setFlow(prevFlow => {
                            const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                            if (selectedBlock) {
                                selectedBlock.data.responseMapping.splice(index, 1);
                            }
                            return { ...prevFlow, blocks: [...prevFlow.blocks] };
                        });
                        saveFlow();
                    });
                });
            }, [saveFlow]);

            const renderConditions = useCallback((conditions, conditionsListElement) => {
                conditionsListElement.innerHTML = '';
                conditions.forEach((condition, index) => {
                    const conditionItem = document.createElement('div');
                    conditionItem.className = 'condition-item';
                    conditionItem.innerHTML = `
                        <input type="text" value="${condition.variable1}" placeholder="Variável 1" data-index="${index}" data-field="variable1">
                        <select data-index="${index}" data-field="operator">
                            <option value="==" ${condition.operator === '==' ? 'selected' : ''}>==</option>
                            <option value="!=" ${condition.operator === '!=' ? 'selected' : ''}>!=</option>
                            <option value=">" ${condition.operator === '>' ? 'selected' : ''}>></option>
                            <option value="<" ${condition.operator === '<' ? 'selected' : ''}><</option>
                            <option value=">=" ${condition.operator === '>=' ? 'selected' : ''}>>=</option>
                            <option value="<=" ${condition.operator === '<=' ? 'selected' : ''}><=</option>
                            <option value="contains" ${condition.operator === 'contains' ? 'selected' : ''}>Contém</option>
                            <option value="not_contains" ${condition.operator === 'not_contains' ? 'selected' : ''}>Não Contém</option>
                        </select>
                        <input type="text" value="${condition.value2}" placeholder="Valor / Variável 2" data-index="${index}" data-field="value2">
                        <button class="remove-button-btn" data-index="${index}"><i class="fas fa-times"></i></button>
                    `;
                    conditionsListElement.appendChild(conditionItem);

                    conditionItem.querySelectorAll('input, select').forEach(input => {
                        input.addEventListener('input', (e) => {
                            setFlow(prevFlow => {
                                const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                                if (selectedBlock && selectedBlock.data.conditions[index]) {
                                    selectedBlock.data.conditions[index][e.target.dataset.field] = e.target.value;
                                }
                                return { ...prevFlow, blocks: [...prevFlow.blocks] };
                            });
                        });
                    });
                    conditionItem.querySelector('.remove-button-btn').addEventListener('click', (e) => {
                        setFlow(prevFlow => {
                            const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                            if (selectedBlock) {
                                selectedBlock.data.conditions.splice(index, 1);
                            }
                            return { ...prevFlow, blocks: [...prevFlow.blocks] };
                        });
                        saveFlow();
                    });
                });
            }, [saveFlow]);


            const populateNextBlockSelect = useCallback((selectElement, currentBlockId, selectedNextBlockId) => {
                if (!selectElement) return;
                selectElement.innerHTML = '<option value="">Nenhum</option>';
                flow.blocks.forEach(block => {
                    if (block.id !== currentBlockId && block.type !== 'start') {
                        const option = document.createElement('option');
                        option.value = block.id;
                        option.textContent = `${block.name || block.type.charAt(0).toUpperCase() + block.type.slice(1)} (${block.id})`;
                        if (block.id === selectedNextBlockId) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                });
            }, [flow.blocks]);

            const drawConnections = useCallback(() => {
                if (!flowLinesSvgRef.current || !flowCanvasRef.current) return;

                flowLinesSvgRef.current.innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#007bff" />
                        </marker>
                        <marker id="arrowhead-true" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#28a745" />
                        </marker>
                        <marker id="arrowhead-false" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#dc3545" />
                        </marker>
                    </defs>
                `;

                flow.blocks.forEach(block => {
                    // Handle single next block connections (message, request)
                    if ((block.type === 'message' || block.type === 'request') && block.data && block.data.nextBlockId) {
                        const fromBlockElement = document.getElementById(block.id);
                        const toBlockElement = document.getElementById(block.data.nextBlockId);
                        if (fromBlockElement && toBlockElement) {
                            const line = createLineElement(fromBlockElement, toBlockElement, '#007bff', 'arrowhead');
                            flowLinesSvgRef.current.appendChild(line);
                        }
                    }
                    // Handle condition block connections
                    if (block.type === 'condition' && block.data) {
                        // True branch
                        if (block.data.nextBlockIdTrue) {
                            const fromBlockElement = document.getElementById(block.id);
                            const toBlockElement = document.getElementById(block.data.nextBlockIdTrue);
                            if (fromBlockElement && toBlockElement) {
                                const line = createLineElement(fromBlockElement, toBlockElement, '#28a745', 'arrowhead-true');
                                flowLinesSvgRef.current.appendChild(line);
                            }
                        }
                        // False branch
                        if (block.data.nextBlockIdFalse) {
                            const fromBlockElement = document.getElementById(block.id);
                            const toBlockElement = document.getElementById(block.data.nextBlockIdFalse);
                            if (fromBlockElement && toBlockElement) {
                                const line = createLineElement(fromBlockElement, toBlockElement, '#dc3545', 'arrowhead-false');
                                flowLinesSvgRef.current.appendChild(line);
                            }
                        }
                    }
                });
            }, [flow.blocks]);

            const createLineElement = useCallback((fromElement, toElement, color, markerId) => {
                const fromRect = fromElement.getBoundingClientRect();
                const toRect = toElement.getBoundingClientRect();
                const canvasRect = flowCanvasRef.current.getBoundingClientRect();

                const x1 = fromRect.left + fromRect.width / 2 - canvasRect.left;
                const y1 = fromRect.top + fromRect.height - canvasRect.top;

                const x2 = toRect.left + toRect.width / 2 - canvasRect.left;
                const y2 = toRect.top - canvasRect.top;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', '2');
                line.setAttribute('marker-end', `url(#${markerId})`);
                return line;
            }, []);

            const handleCanvasMouseDown = useCallback((e) => {
                if (e.button === 0 && !e.target.closest('.flow-block')) {
                    setIsDraggingCanvas(true);
                    flowCanvasWrapperRef.current.classList.add('dragging');
                    dragStartCoords.current = {
                        x: e.clientX - canvasTranslate.x,
                        y: e.clientY - canvasTranslate.y
                    };
                    selectBlock(null);
                }
            }, [canvasTranslate, selectBlock]);

            const handleCanvasMouseMove = useCallback((e) => {
                if (isDraggingCanvas) {
                    const newX = e.clientX - dragStartCoords.current.x;
                    const newY = e.clientY - dragStartCoords.current.y;
                    setCanvasTranslate({ x: newX, y: newY });
                }
            }, [isDraggingCanvas]);

            const handleCanvasMouseUp = useCallback(() => {
                setIsDraggingCanvas(false);
                if (flowCanvasWrapperRef.current) {
                    flowCanvasWrapperRef.current.classList.remove('dragging');
                }
            }, []);

            const handleCanvasMouseLeave = useCallback(() => {
                setIsDraggingCanvas(false);
                if (flowCanvasWrapperRef.current) {
                    flowCanvasWrapperRef.current.classList.remove('dragging');
                }
            }, []);

            const handleFileUpload = useCallback((event, mediaType) => {
                const file = event.target.files[0];
                const selectedBlock = flow.blocks.find(block => block.id === flow.selectedBlockId);

                if (file && selectedBlock) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setFlow(prevFlow => {
                            const updatedBlocks = prevFlow.blocks.map(b => {
                                if (b.id === prevFlow.selectedBlockId) {
                                    const newData = { ...b.data };
                                    if (mediaType === 'image') {
                                        newData.imageDataUrl = e.target.result;
                                        newData.videoDataUrl = '';
                                        newData.audioDataUrl = '';
                                    } else if (mediaType === 'video') {
                                        newData.videoDataUrl = e.target.result;
                                        newData.imageDataUrl = '';
                                        newData.audioDataUrl = '';
                                    } else if (mediaType === 'audio') {
                                        newData.audioDataUrl = e.target.result;
                                        newData.imageDataUrl = '';
                                        newData.videoDataUrl = '';
                                    }
                                    return { ...b, data: newData };
                                }
                                return b;
                            });
                            return { ...prevFlow, blocks: updatedBlocks };
                        });
                        saveFlow();
                        showFeedback(`Arquivo ${file.name} carregado (simulado)!`, 'success');
                    };
                    reader.readAsDataURL(file);
                }
            }, [flow.blocks, flow.selectedBlockId, saveFlow, showFeedback]);

            const handleClearFile = useCallback((mediaType) => {
                setFlow(prevFlow => {
                    const updatedBlocks = prevFlow.blocks.map(b => {
                        if (b.id === prevFlow.selectedBlockId) {
                            const newData = { ...b.data };
                            if (mediaType === 'image') newData.imageDataUrl = '';
                            else if (mediaType === 'video') newData.videoDataUrl = '';
                            else if (mediaType === 'audio') newData.audioDataUrl = '';
                            return { ...b, data: newData };
                        }
                        return b;
                    });
                    return { ...prevFlow, blocks: updatedBlocks };
                });
                // Clear the actual file input element
                if (mediaType === 'image' && imageUploadInputRef.current) imageUploadInputRef.current.value = '';
                if (mediaType === 'video' && videoUploadInputRef.current) videoUploadInputRef.current.value = '';
                if (mediaType === 'audio' && audioUploadInputRef.current) audioUploadInputRef.current.value = '';

                saveFlow();
                showFeedback(`Mídia de ${mediaType} limpa.`, 'info');
            }, [flow.selectedBlockId, flow.blocks, saveFlow, showFeedback]);


            const saveFlow = useCallback(() => {
                try {
                    localStorage.setItem('telegramFlowMVP', JSON.stringify(flow));
                    showFeedback('Fluxo salvo no navegador!', 'success');
                } catch (e) {
                    showFeedback('Erro ao salvar fluxo: ' + e.message, 'error');
                }
            }, [flow, showFeedback]);

            const loadFlow = useCallback(() => {
                try {
                    const savedFlowData = localStorage.getItem('telegramFlowMVP');
                    if (savedFlowData) {
                        const loadedFlow = JSON.parse(savedFlowData);
                        let startBlock = loadedFlow.blocks.find(b => b.type === 'start');
                        if (!startBlock) {
                            startBlock = { id: generateId(), name: 'Início', type: 'start', x: 50, y: 50, data: { messageText: 'Bem-vindo ao seu bot!' } };
                            loadedFlow.blocks.unshift(startBlock);
                        } else {
                            loadedFlow.blocks = loadedFlow.blocks.filter(b => b.id !== startBlock.id);
                            loadedFlow.blocks.unshift(startBlock);
                        }
                        setFlow(loadedFlow);
                        showFeedback('Fluxo carregado do navegador!', 'success');
                    } else {
                        showFeedback('Nenhum fluxo salvo encontrado.', 'info');
                        initializeDefaultFlow();
                    }
                } catch (e) {
                    showFeedback('Erro ao carregar fluxo: ' + e.message, 'error');
                    initializeDefaultFlow();
                }
            }, [generateId, showFeedback]);

            const clearFlow = useCallback(() => {
                if (confirm('Tem certeza que deseja limpar todo o fluxo? Isso não pode ser desfeito.')) {
                    localStorage.removeItem('telegramFlowMVP');
                    initializeDefaultFlow();
                    showFeedback('Fluxo limpo!', 'info');
                }
            }, [showFeedback]);

            const initializeDefaultFlow = useCallback(() => {
                const newStartBlock = { id: generateId(), name: 'Início', type: 'start', x: 50, y: 50, data: { messageText: 'Bem-vindo ao seu bot!' } };
                setFlow({
                    blocks: [newStartBlock],
                    selectedBlockId: null,
                });
            }, [generateId]);

            // Effects
            useEffect(() => {
                loadFlow();
            }, [loadFlow]);

            useEffect(() => {
                renderFlow();
            }, [flow, renderFlow]); // Re-render flow when flow state changes

            useEffect(() => {
                if (flowCanvasRef.current) {
                    flowCanvasRef.current.style.transform = `translate(${canvasTranslate.x}px, ${canvasTranslate.y}px)`;
                    drawConnections();
                }
            }, [canvasTranslate, drawConnections]);


            // Event Handlers for Properties Panel
            const handleSaveBlockProperties = useCallback(() => {
                setFlow(prevFlow => {
                    const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                    if (selectedBlock) {
                        const updatedData = { ...selectedBlock.data };
                        if (selectedBlock.type === 'message' || selectedBlock.type === 'start') {
                            updatedData.messageText = messageTextRef.current ? messageTextRef.current.value : '';
                            updatedData.nextBlockId = messageNextBlockSelectRef.current ? messageNextBlockSelectRef.current.value : '';
                        } else if (selectedBlock.type === 'request') {
                            updatedData.method = requestMethodSelectRef.current ? requestMethodSelectRef.current.value : 'GET';
                            updatedData.url = requestUrlInputRef.current ? requestUrlInputRef.current.value : '';
                            updatedData.body = requestBodyTextareaRef.current ? requestBodyTextareaRef.current.value : '';
                            updatedData.nextBlockId = requestNextBlockSelectRef.current ? requestNextBlockSelectRef.current.value : '';
                        } else if (selectedBlock.type === 'condition') {
                            updatedData.logicOperator = conditionLogicOperatorSelectRef.current ? conditionLogicOperatorSelectRef.current.value : 'and';
                            updatedData.nextBlockIdTrue = conditionNextTrueSelectRef.current ? conditionNextTrueSelectRef.current.value : '';
                            updatedData.nextBlockIdFalse = conditionNextFalseSelectRef.current ? conditionNextFalseSelectRef.current.value : '';
                        }
                        const updatedBlocks = prevFlow.blocks.map(b =>
                            b.id === prevFlow.selectedBlockId ? { ...b, data: updatedData } : b
                        );
                        return { ...prevFlow, blocks: updatedBlocks };
                    }
                    return prevFlow;
                });
                saveFlow();
                showFeedback('Propriedades salvas!', 'success');
            }, [flow.selectedBlockId, saveFlow, showFeedback]);

            const handleAddButtonToBlock = useCallback(() => {
                setFlow(prevFlow => {
                    const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                    if (selectedBlock) {
                        const updatedData = { ...selectedBlock.data };
                        if (!updatedData.buttons) {
                            updatedData.buttons = [];
                        }
                        updatedData.buttons.push({ text: 'Novo Botão' });
                        const updatedBlocks = prevFlow.blocks.map(b =>
                            b.id === prevFlow.selectedBlockId ? { ...b, data: updatedData } : b
                        );
                        return { ...prevFlow, blocks: updatedBlocks };
                    }
                    return prevFlow;
                });
            }, [flow.selectedBlockId]);

            const handleAddRequestHeader = useCallback(() => {
                setFlow(prevFlow => {
                    const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                    if (selectedBlock && selectedBlock.type === 'request') {
                        const updatedData = { ...selectedBlock.data };
                        if (!updatedData.headers) {
                            updatedData.headers = [];
                        }
                        updatedData.headers.push({ key: '', value: '' });
                        const updatedBlocks = prevFlow.blocks.map(b =>
                            b.id === prevFlow.selectedBlockId ? { ...b, data: updatedData } : b
                        );
                        return { ...prevFlow, blocks: updatedBlocks };
                    }
                    return prevFlow;
                });
            }, [flow.selectedBlockId]);

            const handleAddResponseMapping = useCallback(() => {
                setFlow(prevFlow => {
                    const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                    if (selectedBlock && selectedBlock.type === 'request') {
                        const updatedData = { ...selectedBlock.data };
                        if (!updatedData.responseMapping) {
                            updatedData.responseMapping = [];
                        }
                        updatedData.responseMapping.push({ jsonPath: '', variableName: '' });
                        const updatedBlocks = prevFlow.blocks.map(b =>
                            b.id === prevFlow.selectedBlockId ? { ...b, data: updatedData } : b
                        );
                        return { ...prevFlow, blocks: updatedBlocks };
                    }
                    return prevFlow;
                });
            }, [flow.selectedBlockId]);

            const handleAddConditionItem = useCallback(() => {
                setFlow(prevFlow => {
                    const selectedBlock = prevFlow.blocks.find(block => block.id === prevFlow.selectedBlockId);
                    if (selectedBlock && selectedBlock.type === 'condition') {
                        const updatedData = { ...selectedBlock.data };
                        if (!updatedData.conditions) {
                            updatedData.conditions = [];
                        }
                        updatedData.conditions.push({ variable1: '', operator: '==', value2: '' });
                        const updatedBlocks = prevFlow.blocks.map(b =>
                            b.id === prevFlow.selectedBlockId ? { ...b, data: updatedData } : b
                        );
                        return { ...prevFlow, blocks: updatedBlocks };
                    }
                    return prevFlow;
                });
            }, [flow.selectedBlockId]);


            return (
                <div id="flow-creator-page" className="min-h-full flex flex-col">
                    <div className="container">
                        {/* Sidebar de Ferramentas */}
                        <div className="sidebar-tools">
                            <h3>Blocos</h3>
                            <button className="tool-button" onClick={() => addBlock('message', 'Nova Mensagem', 50, 50)}>
                                <i className="fas fa-comment-dots"></i> Adicionar Mensagem
                            </button>
                            <button className="tool-button" onClick={() => addBlock('request', 'Nova Requisição', 50, 50)}>
                                <i className="fas fa-cloud-upload-alt"></i> Adicionar Requisição
                            </button>
                            <button className="tool-button" onClick={() => addBlock('condition', 'Nova Condição', 50, 50)}>
                                <i className="fas fa-question-circle"></i> Adicionar Condição
                            </button>
                            <button className="tool-button" disabled style={{ opacity: 0.6 }}>
                                <i className="fas fa-money-bill-wave"></i> Gerar PIX (Futuro)
                            </button>
                            <hr style={{ borderColor: '#3a3a3a', margin: '20px 0' }} />
                            <h3>Ações do Fluxo</h3>
                            <button className="tool-button button-secondary" onClick={saveFlow}>
                                <i className="fas fa-save"></i> Salvar Fluxo
                            </button>
                            <button className="tool-button button-secondary" onClick={loadFlow}>
                                <i className="fas fa-folder-open"></i> Carregar Fluxo
                            </button>
                            <button className="tool-button button-danger" onClick={clearFlow}>
                                <i className="fas fa-trash-alt"></i> Limpar Fluxo
                            </button>
                        </div>

                        {/* Área do Canvas */}
                        <div
                            className={`flow-canvas-wrapper ${isDraggingCanvas ? 'dragging' : ''}`}
                            ref={flowCanvasWrapperRef}
                            onMouseDown={handleCanvasMouseDown}
                            onMouseMove={handleCanvasMouseMove}
                            onMouseUp={handleCanvasMouseUp}
                            onMouseLeave={handleCanvasMouseLeave}
                        >
                            <div
                                className="flow-canvas"
                                ref={flowCanvasRef}
                                style={{ transform: `translate(${canvasTranslate.x}px, ${canvasTranslate.y}px)` }}
                            >
                                <svg className="flow-lines" ref={flowLinesSvgRef}>
                                    {/* Markers and lines will be drawn by drawConnections */}
                                </svg>
                                {/* Blocks will be injected here via JavaScript */}
                            </div>
                        </div>

                        {/* Painel de Propriedades */}
                        <div className="properties-panel" ref={propertiesPanelRef}>
                            <h3>Propriedades do Bloco</h3>
                            <div id="no-block-selected-message">
                                <p style={{ color: '#b0b0b0' }}>Selecione um bloco no canvas para editar suas propriedades.</p>
                            </div>

                            <div id="block-properties-content" style={{ display: flow.selectedBlockId ? 'block' : 'none' }}>
                                <div className="form-group">
                                    <label htmlFor="block-id-display">ID do Bloco</label>
                                    <input type="text" id="block-id-display" disabled value={flow.selectedBlockId || ''} />
                                </div>

                                <div className="form-group">
                                    <label htmlFor="block-type-display">Tipo</label>
                                    <input type="text" id="block-type-display" disabled value={flow.blocks.find(b => b.id === flow.selectedBlockId)?.type.charAt(0).toUpperCase() + flow.blocks.find(b => b.id === flow.selectedBlockId)?.type.slice(1) || ''} />
                                </div>

                                {/* Propriedades para Bloco de Mensagem */}
                                <div id="message-block-properties" style={{ display: (flow.blocks.find(b => b.id === flow.selectedBlockId)?.type === 'message' || flow.blocks.find(b => b.id === flow.selectedBlockId)?.type === 'start') ? 'block' : 'none' }}>
                                    <div className="form-group">
                                        <label htmlFor="message-text">Texto da Mensagem</label>
                                        <textarea ref={messageTextRef} id="message-text" placeholder="Digite a mensagem do seu bot..."></textarea>
                                    </div>

                                    <div className="form-group">
                                        <label htmlFor="image-upload">Upload de Imagem</label>
                                        <div className="file-input-wrapper">
                                            <input type="file" id="image-upload" accept="image/*" ref={imageUploadInputRef} onChange={(e) => handleFileUpload(e, 'image')} />
                                            <button className="clear-file-btn" onClick={() => handleClearFile('image')}>Limpar</button>
                                        </div>
                                        <small style={{ color: '#7a7a7a' }}>Apenas para visualização no editor. Upload real requer back-end.</small>
                                    </div>

                                    <div className="form-group">
                                        <label htmlFor="video-upload">Upload de Vídeo</label>
                                        <div className="file-input-wrapper">
                                            <input type="file" id="video-upload" accept="video/*" ref={videoUploadInputRef} onChange={(e) => handleFileUpload(e, 'video')} />
                                            <button className="clear-file-btn" onClick={() => handleClearFile('video')}>Limpar</button>
                                        </div>
                                        <small style={{ color: '#7a7a7a' }}>Apenas para visualização no editor. Upload real requer back-end.</small>
                                    </div>

                                    <div className="form-group">
                                        <label htmlFor="audio-upload">Upload de Áudio</label>
                                        <div className="file-input-wrapper">
                                            <input type="file" id="audio-upload" accept="audio/*" ref={audioUploadInputRef} onChange={(e) => handleFileUpload(e, 'audio')} />
                                            <button className="clear-file-btn" onClick={() => handleClearFile('audio')}>Limpar</button>
                                        </div>
                                        <small style={{ color: '#7a7a7a' }}>Apenas para visualização no editor. Upload real requer back-end.</small>
                                    </div>

                                    <div className="form-group" id="buttons-group">
                                        <label>Botões</label>
                                        <div id="buttons-list">
                                            {/* Buttons will be injected here */}
                                        </div>
                                        <button className="button add-button-btn" onClick={handleAddButtonToBlock}>
                                            <i className="fas fa-plus"></i> Adicionar Botão
                                        </button>
                                    </div>

                                    <div className="form-group" id="next-block-group">
                                        <label htmlFor="message-next-block-select">Próximo Bloco (Conexão)</label>
                                        <select ref={messageNextBlockSelectRef} id="message-next-block-select">
                                            <option value="">Nenhum</option>
                                            {/* Options will be loaded via JS */}
                                        </select>
                                        <small style={{ color: '#7a7a7a' }}>Selecione para onde o fluxo irá após este bloco.</small>
                                    </div>
                                </div>

                                {/* Propriedades para Bloco de Requisição */}
                                <div id="request-block-properties" style={{ display: flow.blocks.find(b => b.id === flow.selectedBlockId)?.type === 'request' ? 'block' : 'none' }}>
                                    <div className="form-group">
                                        <label htmlFor="request-method">Método</label>
                                        <select ref={requestMethodSelectRef} id="request-method">
                                            <option value="GET">GET</option>
                                            <option value="POST">POST</option>
                                            <option value="PUT">PUT</option>
                                            <option value="DELETE">DELETE</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label htmlFor="request-url">URL</label>
                                        <input type="text" ref={requestUrlInputRef} id="request-url" placeholder="Ex: https://api.exemplo.com/data" />
                                    </div>
                                    <div className="form-group">
                                        <label>Cabeçalhos</label>
                                        <div id="request-headers-list">
                                            {/* Headers will be injected here */}
                                        </div>
                                        <button className="button add-button-btn" onClick={handleAddRequestHeader}>
                                            <i className="fas fa-plus"></i> Adicionar Cabeçalho
                                        </button>
                                    </div>
                                    <div className="form-group">
                                        <label htmlFor="request-body">Corpo da Requisição (JSON)</label>
                                        <textarea ref={requestBodyTextareaRef} id="request-body" placeholder='Ex: {"key": "value"}'></textarea>
                                        <small style={{ color: '#7a7a7a' }}>Use JSON válido. Variáveis podem ser usadas aqui.</small>
                                    </div>
                                    <div className="form-group">
                                        <label>Mapeamento de Resposta (JSONPath para Variável)</label>
                                        <div id="response-mapping-list">
                                            {/* Response mappings will be injected here */}
                                        </div>
                                        <button className="button add-button-btn" onClick={handleAddResponseMapping}>
                                            <i className="fas fa-plus"></i> Adicionar Mapeamento
                                        </button>
                                        <small style={{ color: '#7a7a7a' }}>Ex: `$.data.name` para `nome_usuario`</small>
                                    </div>
                                    <div className="form-group">
                                        <label htmlFor="request-next-block-select">Próximo Bloco (Conexão)</label>
                                        <select ref={requestNextBlockSelectRef} id="request-next-block-select">
                                            <option value="">Nenhum</option>
                                            {/* Options will be loaded via JS */}
                                        </select>
                                        <small style={{ color: '#7a7a7a' }}>Para onde o fluxo irá após a requisição.</small>
                                    </div>
                                </div>

                                {/* Propriedades para Bloco de Condição */}
                                <div id="condition-block-properties" style={{ display: flow.blocks.find(b => b.id === flow.selectedBlockId)?.type === 'condition' ? 'block' : 'none' }}>
                                    <div className="form-group">
                                        <label htmlFor="condition-logic-operator">Operador Lógico</label>
                                        <select ref={conditionLogicOperatorSelectRef} id="condition-logic-operator">
                                            <option value="and">Todas as condições (AND)</option>
                                            <option value="or">Qualquer condição (OR)</option>
                                        </select>
                                    </div>
                                    <label>Condições</label>
                                    <div id="conditions-list">
                                        {/* Condições serão injetadas aqui */}
                                    </div>
                                    <button className="button add-button-btn" onClick={handleAddConditionItem}>
                                        <i className="fas fa-plus"></i> Adicionar Condição
                                    </button>
                                    <div className="form-group">
                                        <label htmlFor="condition-next-true-select">Próximo Bloco (Se Verdadeiro)</label>
                                        <select ref={conditionNextTrueSelectRef} id="condition-next-true-select">
                                            <option value="">Nenhum</option>
                                            {/* Options will be loaded via JS */}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label htmlFor="condition-next-false-select">Próximo Bloco (Se Falso)</label>
                                        <select ref={conditionNextFalseSelectRef} id="condition-next-false-select">
                                            <option value="">Nenhum</option>
                                            {/* Options will be loaded via JS */}
                                        </select>
                                    </div>
                                </div>

                                <div className="button-group">
                                    <button className="button button-primary" onClick={handleSaveBlockProperties}>Salvar Propriedades</button>
                                    <button className="button button-danger" onClick={deleteSelectedBlock}>Excluir Bloco</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Mensagem de feedback (sucesso/erro) */}
                    <div id="flow-creator-page-feedback-message"></div>
                </div>
            );
        }


        // --- Componente Principal da Aplicação ---
        function App() {
            const [currentPage, setCurrentPage] = useState('landing'); // Nova página inicial padrão
            const [isLoggedIn, setIsLoggedIn] = useState(false); // Estado de autenticação
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [messageBox, setMessageBox] = useState({ message: '', type: '', visible: false });

            const showMessage = (message, type) => {
                setMessageBox({ message, type, visible: true });
            };

            const hideMessage = () => {
                setMessageBox({ ...messageBox, visible: false });
            };

            useEffect(() => {
                // Tenta carregar token do localStorage para verificar se já está logado
                const token = localStorage.getItem('userToken');
                if (token) {
                    setIsLoggedIn(true);
                    setCurrentPage('dashboard'); // Se logado, vai direto para o dashboard
                } else {
                    setCurrentPage('landing'); // Caso contrário, para a nova landing page
                }

                // Carrega a preferência de tema do localStorage
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    setIsDarkMode(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    setIsDarkMode(false);
                }
            }, []);

            useEffect(() => {
                // Aplica a classe 'dark' ao <html> baseado no estado
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                // Salva a preferência no localStorage
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            }, [isDarkMode]);

            const toggleDarkMode = () => {
                setIsDarkMode(prevMode => !prevMode);
            };

            const handleLoginSuccess = () => {
                setIsLoggedIn(true);
                setCurrentPage('dashboard');
            };

            const handleLogout = () => {
                localStorage.removeItem('userToken'); // Remove o token de autenticação
                setIsLoggedIn(false);
                setCurrentPage('landing'); // Volta para a landing page após o logout
                showMessage('Você foi desconectado.', 'info');
            };

            const navigateTo = (page) => {
                if (isLoggedIn || page === 'login' || page === 'signup' || page === 'landing') {
                    setCurrentPage(page);
                } else {
                    // Se tentar navegar para uma página interna sem login, redireciona para login
                    setCurrentPage('login');
                    showMessage('Por favor, faça login para acessar esta funcionalidade.', 'warning');
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans dark:bg-gray-900 transition-colors duration-300">
                    {isLoggedIn && (
                        <Header
                            onNavigate={navigateTo}
                            currentPage={currentPage}
                            toggleDarkMode={toggleDarkMode}
                            isDarkMode={isDarkMode}
                        />
                    )}
                    <main className={`container mx-auto p-4 ${isLoggedIn ? '' : 'flex flex-grow items-center justify-center'}`}>
                        {!isLoggedIn ? (
                            <>
                                {currentPage === 'landing' && <LandingPage onNavigate={navigateTo} />}
                                {currentPage === 'login' && (
                                    <LoginPage
                                        onLoginSuccess={handleLoginSuccess}
                                        onSignUpClick={() => navigateTo('signup')}
                                        showMessage={showMessage}
                                    />
                                )}
                                {currentPage === 'signup' && (
                                    <SignUpPage
                                        onSignUpSuccess={() => navigateTo('login')}
                                        onLoginClick={() => navigateTo('login')}
                                        showMessage={showMessage}
                                    />
                                )}
                            </>
                        ) : (
                            <>
                                {currentPage === 'dashboard' && <Dashboard showMessage={showMessage} />}
                                {currentPage === 'sales' && <SalesPage showMessage={showMessage} />}
                                {currentPage === 'bots' && <BotsPage showMessage={showMessage} />}
                                {currentPage === 'integrations' && <IntegrationsPage showMessage={showMessage} />}
                                {currentPage === 'create-checkout' && <CreateCheckout />}
                                {currentPage === 'campaigns' && <CampaignsPage showMessage={showMessage} />}
                                {currentPage === 'flow-creator' && <FlowCreatorPage />} {/* NEW: Flow Creator Page */}
                                {/* Botão de Logout para quando estiver logado */}
                                <div className="fixed bottom-4 right-4">
                                    <button
                                        onClick={handleLogout}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center text-lg"
                                    >
                                        <i className="fas fa-sign-out-alt mr-2"></i> Logout
                                    </button>
                                </div>
                            </>
                        )}
                    </main>
                    {messageBox.visible && (
                        <MessageBox
                            message={messageBox.message}
                            type={messageBox.type}
                            onClose={hideMessage}
                        />
                    )}
                </div>
            );
        }

        // Renderiza o aplicativo React no elemento 'root' do HTML
        window.onload = function() {
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        };

    </script>
</body>
</html>
